# 菲涅尔效果改进计划 v2.0 - 可见锥体角距方法

## 实现状态

### 已完成 ✅
- [x] **1.1 添加必要uniforms**
  - `uCamPos`: 相机世界坐标
  - `uSphereO`: 球心位置  
  - `uSphereRadius`: 球半径
  - `uRimPower`: 边缘幂次 (设为3.0)
  - `uRimStart`: 边缘开始阈值 (设为0.2)
  - `uRimEnd`: 边缘结束阈值 (设为0.85)

- [x] **1.2 替换菲涅尔计算**
  - 移除基于 `dot(N,V)` 的计算
  - 实现基于角距的可见锥体计算
  - 确保视线方向正确：`vec3 rd = normalize(P - C)`

- [x] **1.3 更新多层云层统一参数**
  - 所有云层使用相同的菲涅尔参数
  - 更新CloudsWithLayers组件参数传递

### 核心实现

#### 可见锥体角距方法公式
```glsl
// 可见锥体中心方向
vec3 Dc = normalize(O - C);

// 可见半角（球在相机处张的角半径）
float thetaV = asin(clamp(R / length(O - C), 0.0, 1.0));

// 当前像素视线与中心方向的夹角
float theta = acos(clamp(dot(rd, Dc), -1.0, 1.0));

// 归一化角距（0=中心，1=几何边缘）
float u = clamp(theta / max(thetaV, 1e-5), 0.0, 1.0);

// 边缘因子
float rimRaw = pow(u, rimPower);
float rimFade = smoothstep(rimStart, rimEnd, rimRaw);
```

#### 当前参数设置
```typescript
// 推荐参数（已实现）
const params = {
  rimPower: 3.0,        // 边缘幂次
  rimStart: 0.2,        // 边缘开始阈值
  rimEnd: 0.85,         // 边缘结束阈值
  fresnelPower: 2.0,    // 颜色菲涅尔幂次
  fresnelStrength: 0.35 // 颜色菲涅尔强度（轻度增强）
};
```

## 下一步计划

### Phase 2: 调试和优化（进行中）
- [ ] **2.1 测试效果验证**
  - 在放大模式下验证"中心不透明、边缘透明"
  - 测试不同相机角度下的效果稳定性
  - 确认解决了反向透明问题

- [ ] **2.2 参数微调**
  - 根据实际效果调整 `rimPower` (2.0-4.0)
  - 优化 `rimStart` 和 `rimEnd` 阈值
  - 测试不同放大级别下的表现

- [ ] **2.3 距离淡化优化**
  - 结合现有的近/远距离淡化功能
  - 确保距离参数与球半径成比例
  - 平滑过渡两种淡化效果

### Phase 3: 高级优化（待定）
- [ ] **3.1 边界情况处理**
  - 处理球像极小或极大的情况
  - 对 `thetaV` 做轻微压缩避免边界问题
  - 添加数值稳定性保护

- [ ] **3.2 性能优化**
  - 添加discard优化
  - 减少重复计算
  - 优化三角函数调用

## 技术要点

### 关键改进
1. **视角无关**：无论相机看到球体的哪一部分，都能正确识别"中心"和"边缘"
2. **数学稳定**：基于角度计算，避免了坐标系转换的问题
3. **统一适用**：同时适用于表层云和体积云
4. **参数一致**：多层云层使用相同的参数，避免叠加冲突

### 解决的问题
- ❌ **之前**：近处透明，远处不透明（反向效应）
- ✅ **现在**：中心不透明，边缘透明（正确效应）

### 实现细节
- 使用 `asin(R/dist)` 计算可见半角，精确反映球体在相机处的张角
- 基于视线与中心方向的夹角 `theta` 来判断片元在可见区域中的位置
- 归一化到 [0,1] 范围，0表示中心，1表示几何边缘
- 使用 `smoothstep` 确保平滑过渡

## 测试验证

### 需要测试的场景
- [ ] 放大模式下的菲涅尔效果
- [ ] 不同相机俯仰角的效果
- [ ] 多层云层叠加的一致性
- [ ] 与现有距离淡化的兼容性

### 预期结果
- **中心区域**：云层不透明
- **边缘区域**：云层逐渐透明
- **过渡效果**：平滑自然，无突变
- **视角稳定性**：不同角度下效果一致

---

*最后更新：2025-09-14 - 实现了可见锥体角距方法*