**目标与背景**
- 背景：当前“变光方向驱动日夜”的链路在坐标对齐、昼夜关灯、副作用（如月球变暗）等方面易出错；相机后续需要自由旋转但画面中地月构图要可控。
- 目标：采用“固定太阳方向 + 旋转地球”的稳定方案；相机绑定地心极坐标以保证构图稳定；月球在主画面难以固定位置，采用画中画（PIP）独立呈现。

**核心决策**
- 单一方向光、常亮：保留一盏太阳方向光，不再因 `altDeg` 关闭；地球夜面由着色器 `max(dot(n,L),0)` 呈现。
- 固定太阳方向（useFixedSun）：
  - 固定方向光 `Lfixed`（建议世界 `[-1,0,0]`）。
  - 每帧计算真实太阳方向 `sunWorld` 后，取 `d1=-sunWorld`（光入射方向）、`d2=Lfixed`，令 `qSun = setFromUnitVectors(d1, d2)`。
  - 地球根节点 `earthRoot.quaternion.premultiply(qSun)`，使“固定光”下的地表受光与真实几何等效。
  - 再执行经度对齐 `alignLongitudeOnly`（绕世界+Y），使目标经线上屏。
- 相机绑定地心极坐标：相机位置用 `(r, θ, φ)` 绕地心摆位、始终 `lookAt(0,0,0)`；不挂在地球组下，避免随地球自转。
- 月球 PIP：主画面保持真实几何；月球以“实时渲染到纹理 + 屏幕叠加”的方式固定在 UI 指定位置和尺寸。

**坐标与约定**
- 世界坐标：Three.js Y-up；已修正 ECEF(Z-up) → World(Y-up) 映射：`World(x,y,z) = ECEF(x,z,y)`。
- 方位角/高度角：Az 0°=北、顺时针；Alt [-90°,90°]。
- 光照方向：使用 -sunWorld 代表“光从太阳射向地球”的方向；固定模式下使用 `Lfixed`。

**渲染与架构**
- 地球/云层：自定义 Shader，独立于 Three 的阴影与标准光照；用 `dot(n, L)` 实现昼夜与终止线。
- 月球：标准材质，依赖方向光；主画面按真实几何受光渲染。PIP 视窗单独渲染一次，保证始终可见且位置固定。
- 星空：不要挂在地球组；保持相机世界固定参考，以免“随地球旋转”。

**逐步实施计划**
- 阶段 1（当日完成）— 最小可用稳态
  - 关闭“按 altDeg 关灯”的逻辑，恢复单光常亮（UI 层）。
  - 引入开关 `useFixedSun`（默认开启）：
    - 固定 `Lfixed`；
    - 计算 `qSun` 并应用到 `earthRoot`；
    - 再执行 `alignLongitudeOnly`（保持现有交互不变）。
  - 自检：
    - 北极圈夏至 00/06/12/18 UTC 均为白天；
    - 赤道春分 06/18 UTC 方位角在东/西象限；
    - 赤道春分 12 UTC 仰角 > 85°；
    - 南北半球昼夜分布与季节一致。

- 阶段 2（1–2 天）— PIP 基础版
  - 在 R3F 使用 `useFBO` 创建小分辨率的 `WebGLRenderTarget`（256–512px）。
  - 第二个小相机：
    - 视图 A：观察者视角看向月球（相位与主画面一致）；或
    - 视图 B：固定构图相机（简化 UI 图标化）。
  - 仅渲染“月球组”到 FBO（可用 layers 过滤）。
  - 在主屏叠加一个屏幕空间四边形显示该纹理（可圆形裁剪 + 描边）。
  - 配置项：位置（屏幕 uv）、尺寸（px）、圆角/描边宽度、分辨率、是否降帧（如 30fps）。

- 阶段 3（2–3 天）— 稳健化与一致性
  - 与 legacy 场景对齐（如 `SimpleEarthMoonScene`）：同样支持 `useFixedSun` 与 PIP。
  - 整理光照与构图参数：统一 `sunIntensity`、`sunIntensityMoon`（若保留）、`lightTempK` 等。
  - 自动化测试扩展：
    - 往返一致性（Az/El ↔ ENU/ECEF ↔ Az/El，非天顶区域 < 0.5°）；
    - 多地点/四季样本对比（astronomy-engine vs 本地实现差值分布 < 0.5°）；
    - PIP 性能（目标渲染时间 < 2ms/f）与降帧开关验证。

**接口与开关（建议）**
- `composition.useFixedSun: boolean`（默认 true）
- `composition.fixedSunDir: [number,number,number]`（默认 [-1,0,0]）
- `composition.enablePIP: boolean`（默认 false）
- `composition.pip: { x: number; y: number; size: number; round: number; border: number; resolution: number; fps: number; camera: 'observer'|'fixed' }`

**测试与验收标准**
- 视觉验收：
  - 极昼/极夜与季节现象正确；昼夜分界线与直射点运动方向正确（俯视北极逆时针）。
  - 相机任意旋转下，地球构图稳定；月球在 PIP 中位置固定、相位正确。
- 自动测试（`?autotest=1`）：
  - Equinox N/S 对称（|altN|≈|altS|）；
  - Arctic circle midnight sun；
  - Equinox east↔west（06Z/18Z 象限）；
  - Equinox noon near-zenith；
  - Night hemisphere negative altitude（按经度相位选择当地午夜）。

**风险与回退**
- 旋转顺序/轴系混用：统一“先 qSun 再 alignLongitudeOnly”，都绕世界轴；相机不在地球组内。
- 星空误挂：星空必须脱离地球组。
- 性能：PIP 分辨率/帧率可控，默认低开销配置。
- 回退：`useFixedSun=false` 时回到“变光方向”模式（保留算法能力）。

**里程碑**
- M1（今日）：useFixedSun 完成，单光常亮，稳定昼夜与阳光方向；自动测试通过。
- M2（+2 天）：PIP α 版（基本功能 + 配置）；验证性能与相位一致性。
- M3（+1–2 天）：legacy 场景接入、自动测试完善、文档与示例。

**备注**
- 时区与夏令时：当前 `byLongitude` 仅用于演示；不影响上述物理现象。后续可引入 IANA TZ 支持作为增强。

