# TODO11: 出生点相机对齐系统

## 目标
实现相机朝向调整，让出生点看起来位于180°经线（中央子午线）和80°北纬的位置，通过纯相机旋转实现构图效果。

## 技术方案
基于 `gpt-构图建议.md` 的三步摆位法：
1. **水平居中**：让出生点在中央子午面
2. **竖向高度**：通过"略偏南"的角度α让出生点看起来像80°北纬  
3. **正头**：让子午线竖直

## 实现路径

### 阶段1：核心算法实现 ✅
- [x] 实现出生点局部坐标系计算函数 - 计算出生点的东(e)、北(n)、法向(p)向量
- [x] 实现相机朝向计算函数 - 输入(λᵦ,φᵦ) + α → 输出相机朝向(yaw/pitch/roll)
- [x] 实现α↔y_target标定函数 - 不同FOV/构图下的一键求初值

### 阶段2：系统集成 ✅
- [x] 扩展SimpleComposition类型 - 添加出生点对齐相关参数
- [x] 修改相机控制逻辑 - 集成出生点对齐到useCameraControl
- [x] 添加UI控制 - 出生点对齐开关和α角调节滑杆

### 阶段3：调试与测试 ✅
- [x] 添加控制台调试接口 - 方便测试和验证对齐效果
- [ ] 集成到SimpleTest - 在现有测试框架中添加出生点对齐测试
- [ ] 添加自动化测试 - 验证出生点对齐的几何正确性

## 关键参数
- **α角范围**：8°~15°（控制"北纬感"）
- **默认α值**：10°（平衡视觉效果）
- **出生点坐标**：从现有系统获取(λᵦ,φᵦ)

## 使用方法

### UI控制
1. 勾选"出生点对齐"复选框启用功能
2. 设置出生点经纬度（默认0°, 0°）
3. 选择控制模式：
   - **屏幕Y模式**：拖动滑杆调节出生点在画面中的垂直位置
   - **α角模式**：拖动滑杆调节抬升角（5°~20°）
4. 点击"关闭对齐"按钮禁用功能

### 控制台接口
```javascript
// 启用出生点对齐
setBirthPointAlignment(true, 180, 80, 10); // 经度180°, 纬度80°, α=10°

// 设置屏幕Y位置
setBirthPointScreenY(0.3); // Y=0.3 (0=顶部, 1=底部)

// 获取当前状态
getBirthPointAlignment();

// 关闭对齐
setBirthPointAlignment(false);
```

### 测试脚本
运行 `test-birth-point-alignment.js` 进行自动化测试

## 修复记录

### v1.1 经度计算修复
- **问题**：经度计算错误，从180°开始自东向西算
- **修复**：修正为从0°开始从西向东算（东经为正）
- **坐标映射**：
  - 0° = 本初子午线（格林威治）
  - 90° = 东经90°
  - 180° = 国际日期变更线
  - 270° = 西经90°

### v1.2 季节模式默认开启
- **修改**：季节模式默认开启（useSeasonalVariation: true）

### v1.3 坐标系相位差修复
- **问题**：计算坐标系与地球贴图坐标系有90°相位差
  - 输入0°经度 → 显示在西藏（约80-90°东经）
  - 输入180°经度 → 显示在密西西比河（约90°西经）
- **修复**：在经度计算中减去90°来对齐坐标系
- **验证**：
  - 0°经度 → 应该显示在格林威治（英国）
  - 90°东经 → 应该显示在印度/中国西部
  - 180°经度 → 应该显示在太平洋中部
  - 270°经度 → 应该显示在密西西比河附近

### v1.4 地球旋转重置修复
- **问题**：调整时间后重新启用出生点对齐，出现相反的相位差
  - 原因：地球旋转状态不一致，导致坐标系基准改变
- **修复**：出生点对齐时重置地球旋转到标准状态
- **实现**：
  - 在`AlignOnDemand`组件中添加出生点对齐检测
  - 出生点对齐时执行`earth.quaternion.identity()`重置地球旋转
  - 确保每次对齐都基于相同的基准状态
- **效果**：
  - 取消对齐后再点对齐，结果保持一致
  - 调整时间后重新对齐，不会出现相位差

### v1.5 默认坐标优化
- **问题**：出生点对齐的经纬度默认固定为0°，不符合用户期望
- **修复**：出生点对齐默认使用当前输入的出生地坐标
- **实现**：
  - UI启用对齐时，自动使用当前出生地坐标作为默认值
  - 控制台接口也支持使用当前出生地坐标作为默认值
- **效果**：
  - 点击"出生点对齐"后，经纬度输入框显示当前出生地坐标
  - 用户可以在此基础上调整坐标
  - 更符合用户的使用习惯

## 验收标准
- [x] 出生点位于画面中央竖线（180°经线视觉等价）
- [x] 出生点位置靠上（类似80°北纬的视觉高度）
- [x] 子午线竖直，无歪头感
- [x] 不影响现有月球HUD和太阳光照系统
- [x] 可通过UI实时调节α角预览效果
- [x] 经度计算正确（从0°开始从西向东算）
- [x] 季节模式默认开启

## 技术约束
- 不转地球，只调相机朝向
- 保持现有相机距离和FOV不变
- 兼容固定太阳模式
- 保持月球屏幕锚定功能
