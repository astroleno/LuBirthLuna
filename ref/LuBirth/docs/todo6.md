# TODO6 月相系统收敛与实现规范（先于相机极坐标）

本说明书抽取并固化“月相先行”的一致方案，目标是先把月相渲染正确、稳定、可验证，再开展相机视角切换与构图工作。

## 目标与范围
- 正确的月相光照：满月整面近亮、新月整面近暗、上/下弦左右对半，不出现“上下半月”。
- 与 three.js 主场景解耦：月相计算与渲染不依赖场景方向光、地球组或层级关系。
- 面向相机的潮汐锁定：月球外观始终以“面向相机”为基准定义月相旋转轴。
- 统一 UTC 时间语义：算法仅使用 UTC 绝对时刻，不进行二次时区修正。

## 坐标与潮汐锁定基准
- 定义以“潮汐锁定后的姿态”为局部坐标基：
  - F（Forward，前）：从月球指向相机的单位向量 F = normalize(camera.position − moon.position)。
  - U（Up，上）：相机上方向经正交化后得到 U' = camera.up − dot(camera.up, F)·F，再归一化。
  - R（Right，右）：R = normalize(F × U')，再令 U = normalize(R × F) 形成严格正交右手系。
- 约定：贴图为“正常显示”做过的固定旋转（如 −90°）隐含在潮锁姿态里，不再用额外补偿回滚坐标系。

## 相位角 → 光照向量（仅方位角旋转）
- 相位角 α 定义：0°=新月，180°=满月，90°/270°≈上/下弦。
- 仅在方位平面 R–F 内旋转，不含 U 分量（Sy=0），避免“上下半月”：《
  - S(α) = −cos(α) · F + sin(α) · R
  - 校验：
    - α=0°（新月）→ S=−F（光从相机背后来，近面最暗）。
    - α=180°（满月）→ S=+F（光从相机方向来，近面最亮）。
    - α=90°/270° → S=±R（左右半月）。
- 向量语义：S 为“从光源指向表面”的方向，直接用于着色器的 `dot(normal, S)`。

## 数据来源与时间语义
- 优先使用 astronomy-engine：从 `Illumination(Body.Moon)` 读取 `phase_angle`（角度）或由 `phase_fraction` 反推，基于 UTC。
- 本地近似算法仅作降级：按朔望月平均周期计算月龄 → α；但仍以 UTC 为输入，不进行 `getTimezoneOffset()` 等二次修正。
- UI/入口负责将用户本地输入转换到 UTC；算法内部只认 UTC 绝对时刻。

## 渲染与集成
- 材质：使用独立 `ShaderMaterial`（Uniform 照明），传入 `sunDirWorldForShading = S_world`。
- 坐标变换：S_world = Sx·R_world + Sy·U_world + Sz·F_world（其中 Sy=0）。R/U/F 由实时相机与月球位置构建。
- 禁止项：
  - 不引入“月球第二盏光”。
  - 不将相机、星空挂在地球组。
  - 不用俯仰（pitch）驱动月相；不添加 z 方向扰动；不随意修改 yaw 除非依据 α。

## 验收与测试
- 关键日期验证（视觉 + 数值）：
  - 2025-09-06（农历七月半，接近满月）→ 近整面亮；`phase_fraction` ≈ 1。 
  - 1993-08-01（农历六月十四，接近满月）→ 近整面亮；`phase_fraction` ≈ 1。
  - 上/下弦日期 → 左右各半，不出现上下分割。
- 人工相位序列验证：α ∈ {0°, 90°, 180°, 270°} 逐步渲染，晨昏线仅左右平移。
- 自动化输出：
  - JSON 含：UTC、α、S_world、期望象限（L/R/Full/New），与 `phase_fraction`。
  - 容差：四分相 α≈90°/270° 时，左右半球亮度差≥阈值；接近满月 `phase_fraction ≥ 0.95`。

## 实施步骤（不改其他系统）
1) 基向量构建器：实现 R/U/F 构造与正交化（输入相机与月球位置）。
2) α 提取：优先从 astronomy-engine 拿 `phase_angle`（度），降级用朔望月法。
3) 光照向量：按 S(α) 生成 `sunDirWorldForShading`，去除任何 U/Z 扰动。
4) Shader 接口：保持现有 Uniform 着色（Lambert + smoothstep terminator），仅替换光向量来源。
5) 测试用例：加控制台函数跑 α 基准序列与关键日期，打印 JSON 校验。

## 风险与回退
- 视角极区退化：当相机靠近极点，R/U/F 可能数值不稳 → 对 U 做稳健正交化并在极限时退回固定 U=(0,1,0) 的近似。
- 时间边界误差：新月/满月附近对 α 较敏感 → UI 提醒并可显示 α 数值与 `phase_fraction`。
- 回退开关：
  - 关闭独立月相光向量 → 回退到 `sunWorld.negate()`（仅用于紧急回滚）。

---

备注：本规范仅约束“月相正确渲染”的坐标/算法与集成，暂不触碰相机极坐标与构图偏移；待月相通过验收后，再据此扩展相机方案（见后续 TODO）。
