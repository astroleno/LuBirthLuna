# 地形阴影系统实现计划

## 📋 总体目标
实现一个"稳定、好调、性能友好"的地球地形阴影系统，避免Three.js复杂的shadowMap，使用片元着色器计算地形自阴影。

## 🎯 实现策略
分层架构，从基础到高级，确保每层都能独立工作并产生可见效果。

---

## 🏗️ 分层实现计划

### 第一阶段：基础地形效果 (Priority: High)
#### 1.1 DEM法线计算
- **目标**: 从高度贴图生成地形法线，增强立体感
- **技术**: Sobel边缘检测算子
- **文件**: `src/scenes/simple/api/components/Earth.tsx`
- **关键参数**:
  - 法线强度: 0.4-0.6
  - 与几何法线混合权重
- **验证**: 山脉轮廓清晰可见，明暗对比明显

#### 1.2 高度图自阴影 (简化版)
- **目标**: 基础地形自遮挡阴影
- **技术**: 沿光照方向4-8步采样
- **算法**: Raymarching高度遮挡检测
- **关键参数**:
  - 采样步数: 4-8步
  - 步长UV距离: 控制阴影长度
  - 高度比例: 影响阴影强度
- **验证**: 山体背光面有明显阴影

#### 1.3 法线混合优化
- **目标**: 合理混合DEM法线与几何法线
- **技术**: 加权混合算法
- **参数**: DEM法线权重 0.4-0.6
- **验证**: 避免过度锐利或模糊

---

### 第二阶段：效果增强 (Priority: Medium)
#### 2.1 近景细节法线 (Triplanar)
- **目标**: 近距离无接缝地形细节
- **技术**: Triplanar投影
- **贴图**: 2-4K可平铺岩石/土壤法线
- **参数**: 
  - 平铺密度: 200-320
  - 细节权重: 0.6-0.9
  - 距离渐隐范围
- **验证**: 贴脸时看到岩石纹理细节

#### 2.2 距离自适应系统
- **目标**: 根据相机距离自动调整参数
- **技术**: 基于距离的参数插值
- **控制项**:
  - 几何分段数 (远:320-384, 近:640-768)
  - 位移强度 (近:2-4x, 远:1x)
  - 细节显示范围
- **验证**: 远近都有合适细节，性能稳定

#### 2.3 简易AO近似
- **目标**: 增强地形凹凸感
- **技术**: 斜率AO (梯度越大越暗)
- **参数**: 强度 0.3-0.6
- **验证**: 地形凹陷处有适当暗化

---

### 第三阶段：高端效果 (Priority: Low)
#### 3.1 POM (Parallax Occlusion Mapping)
- **目标**: 极近距离的深度细节
- **技术**: 视差遮蔽映射
- **条件**: 仅在相机很近时启用
- **参数**:
  - 步数: 10-16
  - 自适应距离阈值
- **验证**: 贴脸时看到表面凹凸深度

#### 3.2 性能优化
- **目标**: 确保稳定60FPS
- **技术**:
  - LOD (Level of Detail) 系统
  - 计算结果缓存
  - 条件分支优化
- **监控**: 内存使用、FPS计数器

---

## 🔧 技术实现要点

### 着色器架构
```glsl
// 顶点着色器
- 基础高度位移
- 距离计算传递
- UV坐标准备

// 片元着色器  
- DEM法线计算 (Sobel)
- 自阴影采样 (Raymarching)
- 法线混合
- 近景细节 (Triplanar)
- AO计算
- 最终光照合成
```

### 关键算法
1. **Sobel边缘检测**: 计算高度梯度得到法线
2. **Raymarching**: 沿光照方向步进检测遮挡
3. **Triplanar投影**: 三个轴向投影混合消除接缝
4. **距离插值**: 平滑过渡不同细节级别

### 性能考虑
- 步数控制在合理范围 (4-16步)
- 避免不必要的纹理采样
- 使用分支优化避免无意义计算
- 根据性能动态调整质量

---

## 📊 验收标准

### 视觉效果
- ✅ 山脉轮廓清晰，明暗对比自然
- ✅ 山体背光面有阴影，不是纯黑
- ✅ 近距离看到岩石纹理细节
- ✅ 远近过渡平滑，无突变
- ✅ 整体立体感强，地形真实

### 性能指标
- ✅ 稳定60FPS (GTX 1060级别)
- ✅ 内存增长可控 (<100MB)
- ✅ 无明显卡顿或掉帧
- ✅ 快速参数调整响应

### 稳定性
- ✅ 无WebGL编译错误
- ✅ 无渲染异常或崩溃
- ✅ 参数调整安全 (不会导致白屏)
- ✅ 不同设备兼容性良好

---

## 🎮 调试工具

### 参数控制面板
```
基础参数:
- DEM法线强度 [0.0-1.0]
- 自阴影步数 [0-16]
- 阴影强度 [0.0-1.0]
- 高度比例 [0.1-2.0]

近景参数:
- 细节法线强度 [0.0-1.0]
- 平铺密度 [50-500]
- 显示距离 [0.1-10.0]
- AO强度 [0.0-1.0]

性能参数:
- 质量等级 [低/中/高]
- 自适应LOD [开/关]
- FPS限制 [30/60/120]
```

### 可视化调试
- 法线可视化开关
- 阴影系数可视化
- 参数实时显示
- 性能监控面板

---

## ⚠️ 风险评估

### 技术风险
- **着色器复杂度**: 片元计算可能影响性能
  - 缓解: 分步实现，每步测试性能
- **精度问题**: 浮点计算可能产生瑕疵
  - 缓解: 使用适当精度，添加容差
- **兼容性**: 不同GPU支持度不同
  - 缓解: 使用广泛支持的GLSL特性

### 时间风险
- **实现复杂度**: 算法比简单阴影复杂
  - 缓解: 采用成熟算法，参考现有实现
- **调试难度**: 参数调整需要经验
  - 缓解: 提供丰富的调试工具

---

## 🎯 成功标准

项目成功的关键指标:
1. **视觉效果显著提升** - 地形立体感和真实感
2. **性能稳定可靠** - 不影响现有帧率
3. **参数调整友好** - 设计师可直观调整
4. **代码质量高** - 可维护、可扩展
5. **无重大bug** - 稳定运行无崩溃

---

*最后更新: 2025-09-13*
*状态: 计划阶段，准备开始实现*