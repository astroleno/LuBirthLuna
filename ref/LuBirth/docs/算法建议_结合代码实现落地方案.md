**目标**
- 基于 `advice_gpt.md` 的算法路径与约定，结合现有实现（`src/astro/ephemeris.ts` 等），给出一套可落地、可验证的太阳方向计算与渲染建议，覆盖坐标约定、时间体系、数值稳健性、测试与工程实践。

**当前实现概览**
- Alt/Az 来源：优先 `astronomy-engine`（`solarAltAzEngine`），失败回退本地实现 `solarAltAz2`（含 GMST/LST、时角与天顶稳健处理）。
- 坐标链路：AltAz → ENU（`altAzToENU`）→ ECEF（`enuToECEF`）→ World（当前等同 ECEF）。
- 方位角约定：0°=北，顺时针（与建议一致）。
- 数值防护：天顶阈值处理（`horizontalProjection < 1e-3`）避免方位角在天顶附近发散。
- 时间换算：`toUTCFromLocal` 以经度近似时区（`offsetHoursFromLongitude`）。
- 测试：`quickTest.ts`/`validation.ts`；日志显示高度角已修复，但方位角在天顶附近仍需策略化处理与测试覆盖。

**建议总览**
- 坐标/角度约定统一：明确并固化 ENU/ECEF/World 的轴向、方位角零点与正向，代码与文档一致；新增往返一致性断言。
- 时间与天文参数：沿用 UTC → JD → GMST/LST 的链路，保持 `astronomy-engine` 为首选，回退本地实现时保留标准公式与 wrap 策略。
- 天顶与地平线稳健性：维持天顶阈值策略；地平线附近可选折射修正；对方位角未定义场景提供稳定输出或状态位。
- 渲染与工程实践：方向光使用世界单位向量；夜间衰减强度/关闭阴影；日志按环境分级；为将来地球模型旋转预留 `M_world<-ecef`。
- 测试与验证：补充方位角断言、天顶附近平滑性测试与角-向量-角往返测试；交叉校准关键时刻。
- 时区处理：避免按经度推时区用于真实时间语义，建议允许显式时区或 IANA TZ 字符串输入。

**详细建议与落地**
- 坐标与角度
  - 方位角：保持“0°=北、顺时针为正”。当前实现已如此（`solarAltAz2` 和 `solarAltAzEngine` 均如此）。
  - ENU 轴向：`altAzToENU` 输出 `{x: East, y: Up, z: North}`；`enuToECEF` 采用组合 `E, U, N` 的顺序（E→x分量、U→y分量、N→z分量）。这与常见 `{x: E, y: N, z: U}` 约定不同，容易混淆。
    - 建议：
      - 在两处函数顶部加注释明确坐标含义与轴顺序；
      - 新增往返一致性测试：Az/El → ENU → ECEF → ENU → Az/El，误差 < 0.5°（非天顶区域）。
      - 可选重构：统一 ENU 为 `{x: E, y: N, z: U}`，同步调整 `enuToECEF` 的线性组合，降低维护成本（建议在单独 PR 完成）。
  - World 对齐：当前 `World ≡ ECEF`。若后续有舞台/构图旋转，增加常量矩阵 `M_world<-ecef` 并在 `computeEphemeris` 中应用一次性线性变换。

- 时间与天文量
  - 首选 `astronomy-engine` 得到 Alt/Az：维持 `solarAltAzEngine` 的路径（已包含像差与折射处理选项）。
  - 回退计算（`solarAltAz2`）：保留 GMST 精确公式（`280.46061837 + 360.98564736629·D`）、LST、时角 wrap 到 [-180°, 180°]，并记录关键量到日志（已实现）。
  - 折射：`Horizon(..., 'normal')` 已引入标准折射；若专注方向光而非日出/日落时刻，可考虑使用 `'none'` 降低偶发抖动，或在近地平线时单独开关。

- 天顶与地平线稳健性
  - 天顶阈值：保留 `horizontalProjection < 1e-3` 的策略；赤道春分“真中天”附近将方位角设定为子午线方向（0°或180°）或沿用上一稳定值，避免 70°± 的漂移（当前实现已加入策略）。
  - 地平线阈值：当 `altDeg` 接近 0° 时，折射影响最大，若视觉上需要平滑，可：
    - 将方位角/高度角在 ±0.5° 内进行缓冲平滑；
    - 或在 `astronomy-engine` 使用 `'normal'` 并对外展示时备注“已含折射”。
  - 状态位：新增字段 `azStable: boolean` 或 `azDefined: boolean`，供 UI 与阴影系统在天顶附近采取特殊 UI/渲染策略。

- 渲染策略（three.js）
  - 方向光：继续以单位向量 `sunWorld` 放大作为 `dirLight.position`，`target` 指向世界原点或当前观测点。
  - 夜间：`el < 0` 时将 `intensity → 0`，关闭阴影节省性能；黄昏/黎明可做缓冲区（例如 `-6°..0°` 渐变）。
  - 未来对齐：若加入地球自转/日夜纹理过渡，保持方向光计算与材质采样一致的世界坐标基准。

- 测试与验证
  - 方位角断言补充：
    - 赤道春分（0°N, 0°E）12:00 附近：`el > 85°` 时允许 `azDefined=false` 或限制在子午线附近（0°/180°）。
    - 上海（31.2°N, 121.5°E）夏至/冬至/春分中午：方位角分别接近 180°/180°/≈180°，误差 < 5°。
  - 平滑性扫描：以 1 分钟步进扫描“天顶±30 分钟”，验证 `azDeg` 单调/不剧烈跳变（允许未定义策略）。
  - 往返一致性：Az/El → ENU → ECEF → ENU → Az/El，确保误差阈值；并覆盖非天顶、非地平线区间。
  - 交叉校准：抽样对比 `astronomy-engine` 与回退实现在多地点、多季节的差值分布（阈值 < 0.5°）。

- 性能与工程实践
  - 日志分级：`logger.log` 在生产构建降级/移除，保留 `warn/error`；关键诊断开关由环境变量控制。
  - 计算缓存：对同一 `dateUtc/lat/lon` 的重复请求做 memoize；或把重复三角量（如 `sinφ`, `cosφ`）提取。
  - 角度工具：集中提供 `wrapDeg/wrapRad/clamp01/asinSafe/acosSafe` 等函数，减少各处自行处理差异。
  - API 纯度：核心函数保持纯函数风格（无副作用、仅依赖入参）。

- 时区与输入
  - 当前 `toUTCFromLocal` 以经度估算时区（四舍五入到 15° 一小时），仅适合测试或理想化设定。现实中时区是行政定义，且有夏令时。
  - 建议：
    - 接口允许传入 IANA 时区字符串（如 `Asia/Shanghai`）或显式偏移；
    - 若缺省，可继续用经度估算，仅用于非真实时间语义的演示模式；
    - 文档明确两种模式的差异，避免用户误读。

**与代码的对应关系**
- `src/astro/ephemeris.ts`
  - `solarAltAzEngine`：保留首选；可参数化折射模式 `'normal'|'none'`。
  - `solarAltAz2`：已采用标准 GMST 与时角 wrap，保留；天顶阈值逻辑建议增加 `azDefined` 状态返回。
  - `altAzToENU`/`enuToECEF`：补充注释与往返测试；评估是否统一 `{x:E,y:N,z:U}`。
  - `computeEphemeris`：预留 `M_world<-ecef` 钩子；夜间强度/阴影策略放在调用处或导出建议。
  - `toUTCFromLocal`/`offsetHoursFromLongitude`：保留作为 demo；新增支持 IANA 时区的重载方法（可后续 PR）。

**渐进式改造计划**
- 第 1 步（快速安全）：
  - 加强注释、导出 `azDefined/azStable` 状态；
  - 为赤道春分与天顶附近补充方位角测试；
  - 统一日志分级并关闭生产噪声。
- 第 2 步（一致性提升）：
  - 增加 ENU/ECEF 往返一致性与角-向量-角往返测试；
  - 可选将 ENU 轴顺序统一为 `{x:E,y:N,z:U}`，并完成最小范围重构。
- 第 3 步（输入健壮）：
  - 为时间输入增加 IANA 时区/显式偏移的支持；
  - 增加 UI 提示“方位角在天顶附近未定义/不稳定”。

**附注**
- 月亮方向（`moonWorld`）现为占位逻辑，后续若加入真实月相与月位角，可直接沿用相同坐标链路，基于太阳/月球几何开展。
- 若后续需要 ECI 路径（方案 B），可在 `solarAltAz2` 上游增加 ECI → GMST → ECEF 的向量级实现，保持与 Alt/Az 路径的一致验证与测试框架。

