# 云层自身阴影功能彻底清理指导

## 概述
本文档指导如何彻底清除云层自身阴影相关的所有代码和配置，包括参数定义、UI控件、Shader实现、组件传参等。

## 清理范围分析

### 1. 类型定义文件 (`src/types/SimpleComposition.ts`)

#### 需要清理的内容：
- **接口定义** (第149-152行)：
  ```typescript
  // 云层自身阴影参数
  cloudUseSelfShadow?: boolean;        // 启用云层自身阴影（默认false）
  cloudSelfShadowStrength?: number;    // 自身阴影强度（默认0.5）
  cloudSelfShadowSteps?: number;       // 自身阴影步数（默认8）
  cloudSelfShadowDistance?: number;    // 自身阴影距离（默认0.02）
  ```

- **默认值定义** (第433-437行)：
  ```typescript
  // 云层自身阴影参数
  cloudUseSelfShadow: true,         // 启用云层自身阴影（默认true）
  cloudSelfShadowStrength: 1.0,     // 自身阴影强度（默认1.0）
  cloudSelfShadowSteps: 16,         // 自身阴影步数（默认16）
  cloudSelfShadowDistance: 0.02,    // 自身阴影距离（默认0.02）
  ```

### 2. 主测试组件 (`src/SimpleTest.tsx`)

#### 需要清理的内容：

**A. 类型定义** (第174-176行)：
```typescript
selfShadowSteps: number;
selfShadowStrength: number;
selfShadowDistance: number;
```

**B. 测试日志输出** (第232行)：
```typescript
selfShadowEnabled: composition.cloudUseSelfShadow ?? false,
```

**C. DEM参数传递** (第439-441行)：
```typescript
selfShadowSteps={demParams.selfShadowSteps}
selfShadowStrength={demParams.selfShadowStrength}
selfShadowDistance={demParams.selfShadowDistance}
```

**D. 云层组件参数传递** (第509-512行)：
```typescript
// 自身阴影参数
useSelfShadow={composition.cloudUseSelfShadow ?? false}
selfShadowStrength={composition.cloudSelfShadowStrength ?? 0.5}
selfShadowSteps={composition.cloudSelfShadowSteps ?? 8}
selfShadowDistance={composition.cloudSelfShadowDistance ?? 0.02}
```

**E. DEM参数默认值** (第726-728行)：
```typescript
selfShadowSteps: 16,
selfShadowStrength: 2.0,
selfShadowDistance: 0.1,
```

**F. UI控件** (第2755-2782行)：
```typescript
{/* 云层自身阴影控制 */}
<div className="row" style={{ marginBottom: 16 }}>
  <h3>云层自身阴影控制</h3>
  <div className="row">
    <label>
      <input type="checkbox" checked={composition.cloudUseSelfShadow ?? false}
             onChange={(e) => updateValue('cloudUseSelfShadow', e.target.checked)} /> 启用云层自身阴影（大幅提升体积感）
    </label>
  </div>
  <div className="row">
    <label className="label">自身阴影强度: {(composition.cloudSelfShadowStrength ?? 0.5).toFixed(2)}</label>
    <input className="input" type="range" min={0} max={1} step={0.1}
           value={composition.cloudSelfShadowStrength ?? 0.5}
           onChange={(e) => updateValue('cloudSelfShadowStrength', parseFloat(e.target.value))} />
  </div>
  <div className="row">
    <label className="label">自身阴影步数: {composition.cloudSelfShadowSteps ?? 8}</label>
    <input className="input" type="range" min={4} max={16} step={1}
           value={composition.cloudSelfShadowSteps ?? 8}
           onChange={(e) => updateValue('cloudSelfShadowSteps', parseInt(e.target.value))} />
  </div>
  <div className="row">
    <label className="label">自身阴影距离: {(composition.cloudSelfShadowDistance ?? 0.02).toFixed(3)}</label>
    <input className="input" type="range" min={0.005} max={0.05} step={0.005}
           value={composition.cloudSelfShadowDistance ?? 0.02}
           onChange={(e) => updateValue('cloudSelfShadowDistance', parseFloat(e.target.value))} />
  </div>
</div>
```

**G. DEM参数UI控件** (第2391-2409行)：
```typescript
// 自身阴影步数、强度、距离的UI控件
```

**H. "对齐放大"按钮参数** (第2963-2967行和第3010-3014行)：
```typescript
// 启用云层自身阴影
cloudUseSelfShadow: true,
cloudSelfShadowStrength: 1.00,
cloudSelfShadowSteps: 16,
cloudSelfShadowDistance: 0.02
```

### 3. 云层组件 (`src/scenes/simple/api/components/Clouds.tsx`)

#### 需要清理的内容：

**A. Clouds组件参数定义** (第230-234行)：
```typescript
// 自身阴影参数
useSelfShadow = false,
selfShadowStrength = 0.5,
selfShadowSteps = 8,
selfShadowDistance = 0.02,
```

**B. Clouds组件类型定义** (第283-287行)：
```typescript
// 自身阴影参数
useSelfShadow?: boolean;
selfShadowStrength?: number;
selfShadowSteps?: number;
selfShadowDistance?: number;
```

**C. Shader材质uniforms** (第342-346行)：
```typescript
// 自身阴影参数
useSelfShadow: { value: useSelfShadow ?? false },
selfShadowStrength: { value: selfShadowStrength ?? 0.5 },
selfShadowSteps: { value: selfShadowSteps ?? 8 },
selfShadowDistance: { value: selfShadowDistance ?? 0.02 },
```

**D. Fragment Shader uniforms声明** (第407-410行)：
```glsl
uniform bool useSelfShadow;
uniform float selfShadowStrength;
uniform int selfShadowSteps;
uniform float selfShadowDistance;
```

**E. calculateSelfShadow函数** (第510-544行)：
```glsl
// 云层自身阴影计算函数
float calculateSelfShadow(vec2 uv, vec3 lightDir, vec3 normal) {
  if (!useSelfShadow) return 1.0;
  
  // 计算光照方向在UV空间的投影
  vec3 lightDirNormalized = normalize(lightDir);
  vec2 lightDirUV = lightDirNormalized.xz * selfShadowDistance;
  
  // 步进采样计算阴影
  float shadow = 1.0;
  float stepSize = 1.0 / float(selfShadowSteps);
  
  for (int i = 0; i < 16; i++) {
    if (i >= selfShadowSteps) break;
    
    float t = float(i) * stepSize;
    vec2 shadowUV = uv - lightDirUV * t;
    
    // 检查UV边界
    if (shadowUV.x < 0.0 || shadowUV.x > 1.0 || shadowUV.y < 0.0 || shadowUV.y > 1.0) {
      break;
    }
    
    // 采样云层密度
    float cloudDensity = texture2D(map, shadowUV).r;
    
    // 如果遇到高密度云层，产生阴影
    if (cloudDensity > 0.3) {
      float shadowFactor = cloudDensity * selfShadowStrength * (1.0 - t);
      shadow = min(shadow, 1.0 - shadowFactor);
    }
  }
  
  return shadow;
}
```

**F. 主函数中的自身阴影计算和应用** (第611-612行和第626-627行)：
```glsl
// 计算自身阴影
float selfShadow = calculateSelfShadow(vUv, lightDir, n);

// 应用自身阴影到光照
float shadowedLight = l * selfShadow;
```

**G. useEffect依赖数组** (第746行)：
```typescript
}, [cloudMaterial, texture, lightDir, lightColor, strength, sunI, cloudGamma, cloudBlack, cloudWhite, cloudContrast, displacementScale, displacementBias, scrollSpeedU, scrollSpeedV, useTriplanar, triplanarScale, useVolumeScattering, volumeDensity, scatteringStrength, scatteringG, rimEffect, densityEnhancement, scatteringColor, noiseScale, noiseStrength, useThicknessMapping, thicknessScale, thicknessBias, thicknessPower, useSelfShadow, selfShadowStrength, selfShadowSteps, selfShadowDistance, opacity]);
```

**H. CloudsWithLayers组件参数定义** (第832-836行)：
```typescript
// 自身阴影参数
useSelfShadow = false,
selfShadowStrength = 0.5,
selfShadowSteps = 8,
selfShadowDistance = 0.02,
```

**I. CloudsWithLayers组件类型定义** (第886-890行)：
```typescript
// 自身阴影参数
useSelfShadow?: boolean;
selfShadowStrength?: number;
selfShadowSteps?: number;
selfShadowDistance?: number;
```

**J. CloudsWithLayers组件参数传递** (第1013-1016行)：
```typescript
useSelfShadow={useSelfShadow ?? false}
selfShadowStrength={selfShadowStrength ?? 0.5}
selfShadowSteps={selfShadowSteps ?? 8}
selfShadowDistance={selfShadowDistance ?? 0.02}
```

### 4. 地球组件 (`src/scenes/simple/api/components/Earth.tsx`)

#### 需要清理的内容：

**A. Earth组件参数定义** (第79-81行)：
```typescript
selfShadowSteps = 16,
selfShadowStrength = 2.0,
selfShadowDistance = 0.1,
```

**B. Earth组件类型定义** (第158-160行)：
```typescript
selfShadowSteps?: number;
selfShadowStrength?: number;
selfShadowDistance?: number;
```

**C. Earth Shader材质uniforms** (第258-260行)：
```typescript
selfShadowSteps: { value: selfShadowSteps },
selfShadowStrength: { value: selfShadowStrength },
selfShadowDistance: { value: selfShadowDistance },
```

**D. Earth Fragment Shader uniforms声明** (第481-483行)：
```glsl
uniform int selfShadowSteps;
uniform float selfShadowStrength;
uniform float selfShadowDistance;
```

**E. Earth Shader中的自身阴影计算** (第672-673行和第678行)：
```glsl
aoShadow = calculateAO(vUv, displacementMap, selfShadowSteps, selfShadowDistance, aoHeightThreshold, aoDistanceAttenuation, aoMaxOcclusion, aoSmoothFactor);
aoShadow = mix(1.0, aoShadow, selfShadowStrength);

directionalShadow = calculateDirectionalShadow(vUv, lightDir, n, displacementMap, selfShadowSteps, selfShadowDistance, directionalShadowSoftness, directionalShadowSharpness, directionalShadowContrast);
```

**F. Earth Shader中的其他自身阴影引用** (第804行和第812行)：
```glsl
float ao = calculateAO(vUv, displacementMap, selfShadowSteps, selfShadowDistance, aoHeightThreshold, aoDistanceAttenuation, aoMaxOcclusion, aoSmoothFactor);

float directionalShadow = calculateDirectionalShadow(vUv, lightDir, n, displacementMap, selfShadowSteps, selfShadowDistance, directionalShadowSoftness, directionalShadowSharpness, directionalShadowContrast);
```

**G. Earth组件useEffect中的uniform更新** (第980-987行)：
```typescript
if ((earthDNMaterial.uniforms as any).selfShadowSteps !== undefined) {
  (earthDNMaterial.uniforms as any).selfShadowSteps.value = selfShadowSteps ?? 16;
}
if ((earthDNMaterial.uniforms as any).selfShadowStrength !== undefined) {
  (earthDNMaterial.uniforms as any).selfShadowStrength.value = selfShadowStrength ?? 2.0;
}
if ((earthDNMaterial.uniforms as any).selfShadowDistance !== undefined) {
  (earthDNMaterial.uniforms as any).selfShadowDistance.value = selfShadowDistance ?? 0.1;
}
```

**H. Earth组件useEffect依赖数组** (第1047行和第1071行)：
```typescript
}, [earthDNMaterial, lightDirection, sunIntensity, lightColor, rimStrength, rimWidth, rimHeight, rimRadius, haloWidth, useNormalMap, normalMapStrength, normalFlipX, normalFlipY, earthNormal, earthDisplacement, displacementScaleRel, displacementMid, displacementContrast, size, receiveShadows, cloudShadowMap, cloudShadowStrength, enableCloudShadow, demNormalStrength, demNormalWeight, selfShadowSteps, selfShadowStrength, selfShadowDistance, debugMode, aoHeightThreshold, aoDistanceAttenuation, aoMaxOcclusion, aoSmoothFactor, enableDirectionalShadow, directionalShadowStrength, directionalShadowSoftness, directionalShadowSharpness, directionalShadowContrast, nightEarthMapIntensity, nightEarthMapHue, nightEarthMapSaturation, nightEarthMapLightness, nightGlowBlur, nightGlowOpacity]);

}, [position, size, lightDirection, useTextures, earthMap, earthNight, earthSpecular, earthDisplacement, demNormalStrength, demNormalWeight, selfShadowSteps, selfShadowStrength, selfShadowDistance]);
```

**I. Earth组件参数传递** (第1064-1066行)：
```typescript
selfShadowSteps,
selfShadowStrength,
selfShadowDistance
```

## 清理步骤

### 步骤1：清理类型定义
1. 从 `src/types/SimpleComposition.ts` 中移除所有自身阴影相关的接口定义和默认值

### 步骤2：清理主测试组件
1. 从 `src/SimpleTest.tsx` 中移除所有自身阴影相关的：
   - 类型定义
   - UI控件
   - 参数传递
   - 默认值设置
   - "对齐放大"按钮中的参数

### 步骤3：清理云层组件
1. 从 `src/scenes/simple/api/components/Clouds.tsx` 中移除：
   - 所有自身阴影相关的参数定义和类型
   - Shader中的uniforms声明
   - `calculateSelfShadow` 函数
   - 主函数中的自身阴影计算和应用
   - useEffect依赖数组中的自身阴影参数

### 步骤4：清理地球组件
1. 从 `src/scenes/simple/api/components/Earth.tsx` 中移除：
   - 所有自身阴影相关的参数定义和类型
   - Shader中的uniforms声明
   - Shader中的自身阴影计算调用
   - useEffect中的uniform更新
   - useEffect依赖数组中的自身阴影参数

### 步骤5：验证清理结果
1. 运行项目确保没有编译错误
2. 检查UI中不再显示自身阴影相关控件
3. 确认"对齐放大"按钮不再设置自身阴影参数
4. 验证云层渲染正常，没有自身阴影效果

## 注意事项

1. **Shader编译**：移除Shader中的uniforms和函数后，确保Shader能正常编译
2. **依赖数组**：清理useEffect依赖数组时，确保不遗漏任何自身阴影相关的参数
3. **参数传递**：确保所有组件间的参数传递都正确移除
4. **默认值**：移除默认值后，确保其他功能不受影响
5. **UI一致性**：确保UI中不再有任何自身阴影相关的控件或文本

## 清理后的效果

清理完成后，云层系统将：
- 不再有自身阴影计算，提升渲染性能
- 简化Shader代码，减少uniform数量
- 简化UI界面，移除相关控件
- 简化参数传递，减少组件复杂度
- 保持体积散射和厚度映射等其他功能正常工作
