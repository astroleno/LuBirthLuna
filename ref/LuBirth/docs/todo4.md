# TODO4 实现计划：月相与PIP系统

## 总体目标
基于"地球固定垂直 + 太阳方向反推"架构，实现准确的月相变化和PIP潮汐锁定展示。

## 当前状态分析

### 已完成工作 ✅
- [x] 月球潮汐锁定四元数计算
- [x] 月球材质支持Uniform照明
- [x] PIP专用月球网格克隆（但设计错误）
- [x] 真实物理向量支持
- [x] 基础集成到SimpleTest.tsx

### 发现的问题 ❌
- [x] sunWorld.clone()错误 → 已修复
- [ ] PIP分层逻辑错误 → 需要重新设计
- [ ] PIP创建了第二个月球 → 应该拍摄真实月球
- [ ] 相机2没有跟随月球自转 → 需要实现跟随机制
- [ ] 月球自转与月相计算不准确 → 需要优化算法

## 详细实现计划

### 阶段1：修复基础架构问题

#### 1.1 重新设计分层渲染系统
**目标**：建立正确的分层逻辑，支持相机2独立渲染月球

**具体任务**：
- [ ] 重新定义分层策略：
  - Layer 0：主场景（地球、星空）
  - Layer 1：真实月球（对主相机可能隐藏）
  - Layer 2：PIP投射平面
- [ ] 修改月球组件的分层控制
- [ ] 设置相机2的渲染层为Layer 1
- [ ] 设置主相机的渲染层为Layer 0

**验收标准**：
- 主相机只能看到地球和星空
- 相机2只能看到月球
- PIP平面正确显示在主场景中

#### 1.2 实现相机2跟随月球自转
**目标**：相机2完美跟随月球自转，保持潮汐锁定视角

**具体任务**：
- [ ] 计算月球自转角度（基于太阳方向和日期时间）
- [ ] 实现相机2位置跟随算法
- [ ] 确保相机2始终对准月球潮汐锁定面
- [ ] 优化相机距离和角度参数

**关键算法**：
```typescript
// 相机2跟随算法
const cameraOffset = new THREE.Vector3(0, 0, distance);
const moonRotationMatrix = new THREE.Matrix4().makeRotationY(moonRotationAngle);
const cameraPosition = moonPosition.clone().add(cameraOffset.applyMatrix4(moonRotationMatrix));
```

**验收标准**：
- 相机2始终从月球"背后"观察
- 月球在PIP中保持相对静止
- 月相变化清晰可见

### 阶段2：优化月相计算

#### 2.1 完善太阳光方向计算
**目标**：确保太阳光方向包含黄赤交角和季相变化

**具体任务**：
- [ ] 检查当前太阳光计算算法
- [ ] 确认黄赤交角（23.44°）已正确应用
- [ ] 验证季相变化对太阳方位的影响
- [ ] 优化太阳方向向量计算

**验收标准**：
- 不同季节的太阳角度正确
- 太阳方向与真实天文数据一致

#### 2.2 优化月球自转算法
**目标**：月球自转准确反映月相变化

**具体任务**：
- [ ] 基于太阳方向计算月球正确朝向
- [ ] 实现潮汐锁定约束（同一面朝向地球）
- [ ] 同步月球自转与公转周期
- [ ] 添加月相周期计算（29.53天）

**关键算法**：
```typescript
// 月球自转算法
const moonPhaseAngle = calculateMoonPhase(date, earthPosition, moonPosition);
const moonRotation = syncWithEarthRotation(earthRotation, moonPhaseAngle);
```

**验收标准**：
- 月相变化与实际日期对应
- 潮汐锁定效果正确
- 月球同一面始终朝向地球

### 阶段3：完善PIP系统

#### 3.1 优化FBO渲染质量
**目标**：提高PIP渲染效果和性能

**具体任务**：
- [ ] 优化FBO分辨率设置
- [ ] 改进抗锯齿和纹理过滤
- [ ] 优化渲染循环性能
- [ ] 添加HDR支持（如果需要）

**验收标准**：
- PIP图像清晰无锯齿
- 渲染帧率稳定在60fps
- 内存使用合理

#### 3.2 完善用户交互
**目标**：提供良好的用户控制体验

**具体任务**：
- [ ] 添加PIP开关控制
- [ ] 支持PIP位置和大小调整
- [ ] 添加调试信息显示
- [ ] 优化移动端适配

**验收标准**：
- 用户可以方便控制PIP
- 调试信息有助于开发
- 响应式设计良好

### 阶段4：测试与验证

#### 4.1 功能测试
**目标**：验证所有功能正确性

**测试用例**：
- [ ] 不同日期时间的月相验证
- [ ] 季节变化对太阳光的影响
- [ ] PIP跟随机制的正确性
- [ ] 潮汐锁定效果的稳定性

**测试数据**：
- 春分、夏至、秋分、冬至
- 新月、上弦月、满月、下弦月
- 不同经纬度的观测效果

#### 4.2 性能测试
**目标**：确保系统性能满足要求

**测试指标**：
- [ ] 渲染帧率监控
- [ ] 内存使用分析
- [ ] GPU占用率检查
- [ ] 移动设备性能测试

#### 4.3 用户体验测试
**目标**：验证用户交互体验

**测试内容**：
- [ ] 操作响应速度
- [ ] 界面友好度
- [ ] 功能易用性
- [ ] 错误处理机制

## 技术实现细节

### 关键文件修改

#### `/src/SimpleTest.tsx`
- 修改月球分层设置
- 添加PIP相机控制
- 优化太阳光计算

#### `/src/scenes/simple/components/Moon.tsx`
- 完善潮汐锁定算法
- 优化自转计算
- 改进材质渲染

#### `/src/scenes/simple/components/PhysicalMoonPIP.tsx`
- 重构相机跟随逻辑
- 移除第二个月球
- 优化FBO渲染

#### 新增文件
- `/src/scenes/simple/utils/moonPhaseCalculator.ts` - 月相计算工具
- `/src/scenes/simple/utils/sunDirectionCalculator.ts` - 太阳方向计算工具

### 依赖库要求
- THREE.js r128+
- React 18+
- astronomy-engine（如果需要更精确的天文计算）

## 风险评估与应对

### 技术风险
1. **性能问题**：双相机渲染可能影响性能
   - 应对：优化渲染管线，使用LOD技术
   
2. **计算精度**：天文计算可能存在精度问题
   - 应对：使用高精度数学库，验证计算结果

3. **兼容性问题**：不同设备的WebGL支持
   - 应对：添加降级方案，兼容性检测

### 进度风险
1. **复杂度超预期**：月相计算可能比预期复杂
   - 应对：分阶段实现，先保证基础功能

2. **调试困难**：3D场景调试可能比较困难
   - 应对：添加完善的调试工具和日志

## 成功标准

### 功能标准
- [ ] 月相变化与实际日期完全对应
- [ ] PIP正确展示潮汐锁定效果
- [ ] 太阳方向包含季相变化
- [ ] 用户交互流畅自然

### 性能标准
- [ ] 渲染帧率 ≥ 60fps
- [ ] 内存占用 ≤ 100MB
- [ ] 加载时间 ≤ 3秒

### 质量标准
- [ ] 代码覆盖率 ≥ 80%
- [ ] 无内存泄漏
- [ ] 跨浏览器兼容

## 下一步行动

1. **立即开始**：阶段1.1 - 重新设计分层渲染系统
2. **并行进行**：阶段2.1 - 完善太阳光方向计算
3. **持续验证**：每个小阶段完成后进行功能测试

---

*本计划将根据实际开发进度和发现的问题进行动态调整。*