# TODO2: 太阳算法系统紧急修复任务

## 🚨 紧急任务（今天完成）

### 1. 切换主算法到solarAltAz2
- [ ] 修改`computeEphemeris`函数，从`solarAltAzEngine`切换到`solarAltAz2`
- [ ] 添加配置开关，保留`astronomy-engine`作为备选路径
- [ ] 在`solarAltAz2`返回中添加`azDefined`字段
- [ ] 测试赤道春分中午方位角：期望从72.8°修复为0°

### 2. 完善天顶处理逻辑
- [ ] 在`solarAltAz2`中完善天顶阈值处理
- [ ] 天顶附近设置`azDefined = false`
- [ ] 添加天顶±30分钟扫描测试
- [ ] 验证方位角平滑性

### 3. 修复时间转换问题
- [ ] 检查`toUTCFromLocal`函数的时区转换逻辑
- [ ] 修复赤道春分正午高度角问题（当前-31.36°，期望80°+）
- [ ] 验证时间日期对应关系

## ⚡ 高优先级任务（本周完成）

### 4. 坐标转换标准化
- [ ] 统一`altAzToENU`和`enuToECEF`函数
- [ ] 添加坐标约定注释（{x:E, y:U, z:N}）
- [ ] 实现往返一致性测试：Az/El → ENU → ECEF → ENU → Az/El
- [ ] 误差阈值设置为<0.5°

### 5. 验证测试增强
- [ ] 完善方位角验证测试
- [ ] 添加天顶附近方位角断言
- [ ] 修复验证测试期望值
- [ ] 目标：验证通过率从5/8提升到8/8

### 6. 类型系统扩展
- [ ] 在`Ephemeris`接口中添加`azDefined: boolean`字段
- [ ] 确保向后兼容性
- [ ] 更新相关类型定义

## 📈 中优先级任务（下周完成）

### 7. 数值稳定性增强
- [ ] 添加角度工具函数：`wrapDeg`, `wrapRad`, `asinSafe`, `acosSafe`
- [ ] 增强零向量检查
- [ ] 添加数值稳定性测试

### 8. 光照系统优化
- [ ] 优化`lightingUtils.ts`中的光照设置
- [ ] 添加夜间渐变处理
- [ ] 实现阴影开关逻辑
- [ ] 使用`azDefined`状态优化渲染

### 9. 日志系统标准化
- [ ] 实现日志分级（生产环境降噪）
- [ ] 标准化调试输出格式
- [ ] 添加性能监控日志

## 🔧 低优先级任务（后续优化）

### 10. 性能优化
- [ ] 实现计算缓存机制
- [ ] 优化重复计算
- [ ] 添加性能监控

### 11. 时区处理增强
- [ ] 支持IANA时区字符串输入
- [ ] 提供显式偏移接口
- [ ] 保留当前经度估算作为演示模式

### 12. 错误处理完善
- [ ] 增强异常处理机制
- [ ] 添加错误恢复逻辑
- [ ] 完善用户友好的错误提示

## 📊 成功标准

### 立即验证指标
- ✅ 赤道春分中午方位角：0°（当前72.8°）
- ✅ 验证测试通过率：8/8（当前5/8）
- ✅ 赤道春分正午高度角：80°+（当前-31.36°）

### 系统稳定性指标
- ✅ 天顶附近方位角计算稳定
- ✅ 坐标转换往返一致性误差<0.5°
- ✅ 数值计算无异常值

### 性能指标
- ✅ 计算响应时间<10ms
- ✅ 内存使用稳定
- ✅ 无内存泄漏

## 🎯 执行策略

1. **立即开始**：紧急任务1-3
2. **并行执行**：高优先级任务4-6
3. **逐步推进**：中低优先级任务按计划执行
4. **持续验证**：每个任务完成后立即测试验证

## ⚠️ 风险控制

- **配置开关**：保留`astronomy-engine`作为备选，可随时回滚
- **分阶段实施**：每个阶段独立验证，降低风险
- **向后兼容**：新增字段不影响现有调用
- **测试覆盖**：每个修改都有对应测试验证
