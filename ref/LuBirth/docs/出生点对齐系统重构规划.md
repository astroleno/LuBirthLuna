# 出生点对齐系统重构规划

基于顶层设计约束，修复地球自转失效问题，确保：
1. **太阳光固定原则**：太阳光方向保持不变，只有季相变化
2. **地球自转原则**：地球沿地轴（Y轴）旋转，符合真实物理
3. **时区支持原则**：正确处理不同时区的时间转换
4. **月球解耦原则**：月球位置和相位独立于地球时间系统
5. **纹理映射原则**：贴图seam位于国际日期变更线
6. **相机控制原则**：支持完整的俯仰角、方位角和视点控制

## 背景与目标
- **目标**：让“出生点对齐”稳定、可预期、可回归。严格遵守协作指南：固定太阳模式优先；出生对齐只动相机，不动地球；相机与地球、星空解耦。
- **现状痛点**：
  - 旋转来源冲突：`earthRoot.quaternion`、`composition.earthYawDeg`、`__EARTH_QUAT`、`AlignOnDemand` 并存，互相覆盖/叠加。
  - 职责边界混乱：出生对齐时仍有路径在“转地球”，相机链路被其它 effect 覆盖。
  - 坐标口径不一致：局部/世界/ECEF/ENU 与贴图经纬映射混用，`atan2`/deg-rad 细节易错。
  - 状态时序/异步：React 批量更新 + R3F 直接写场景，导致竞态与抖动。

## 设计原则
- **单一来源**：地球姿态“唯一真实来源”= 场景节点 `earthRoot.quaternion`。所有读取从此处获得。
- **职责清晰**：
  - 出生对齐模式：只动相机；不动地球；光照与季节仅影响光，不写地球。
  - 非出生对齐模式：可由 `AlignOnDemand` 仅绕世界 +Y 调整 yaw；不重置地球四元数，不覆盖基础自转。
- **顺序约束**：统一“先固定太阳 yaw（世界 +Y）→ 再 `alignLongitudeOnly()`（仍绕世界 +Y）”，严禁混入 pitch/roll。
- **可回归**：提供一键诊断与 JSON 输出，覆盖典型经纬与边界条件。

## 改动分阶段计划

### 阶段 A：读取/写入来源收敛（无 UI 变更）
1. `src/scenes/simple/utils/birthPointAlignment.ts`
   - 读取地球姿态：改为只从 `scene.getObjectByName('earthRoot').quaternion` 获取；删除 `__EARTH_QUAT` 与 `composition.earthYawDeg` 分支。
   - 相机反解：`w = rotate(p, earthRoot.quaternion)` 后计算 `yaw = atan2(w.x, w.z)；pitch = asin(clamp(w.y)) − alphaDeg`。
   - 加健壮日志与 try-catch，输出：读取到的四元数、`p`/`w`、`yaw/pitch/roll`。
2. `src/SimpleTest.tsx` 的 `AlignOnDemand`
   - 保留“仅绕世界 +Y 计算 deltaYaw 并 rotateOnWorldAxis”的实现；确保不调用 `quaternion.identity()`。
   - 出生对齐模式下继续 `return` 跳过；并确认无其它路径每帧转地球。
3. 删除/屏蔽所有对 `__EARTH_QUAT`、`composition.earthYawDeg` 的读取用作姿态源的代码。

验收标准：
- 打开日志，确认出生对齐时不出现任何“转地球”的日志；仅出现“相机应用”的日志。
- 非出生对齐模式下，`AlignOnDemand` 每帧只输出 `deltaYaw`，不重置四元数。

### 阶段 B：effect 依赖与控制链路精简
1. 出生对齐 effect 依赖数组仅保留：`enableBirthPointAlignment`、经纬度、`alphaDeg`。
   - 移除 `earthYawDeg/dateISO/latDeg/lonDeg` 等实时更新依赖，避免循环触发。
2. 统一相机控制入口：
   - 在现有 `useCameraControl` 基础上，新增 `mode` 选择：`birthpoint | manual | auto`；出生对齐时相机位置/朝向只由对齐计算写入。
   - 禁止同时存在“直接操作相机”的其它高频路径；必须通过统一入口。

验收标准：
- 出生对齐开启后，相机角度不会被 10 秒实时更新覆盖；关闭后恢复原自动/手动逻辑。
- 连续 60 秒观察无“抖动/跳回”。

### 阶段 C：诊断工具与自动化回归
1. 新增控制台命令 `runBirthAlignDiagnostics()`：
   - 输入：测试集（若为空，使用内置样例：赤道 0/90/180/-90，经纬边界 80N/80S 等）。
   - 输出：JSON 数组，字段含 `lon/lat/alpha`、读取到的 `earthRoot.quaternion`、反解 `yaw/pitch`、最终误差角（出生点相机中心夹角）。
   - 打印 `[BirthAlignTest:JSON]`，便于保存回归。
2. 在 `src/main.tsx` 注入命令；在文档中给出 URL 参数与控制台用法。

验收标准：
- 内置样例 `max(errorDeg) ≤ 0.5°`；极值场景（高纬、alpha 大角）`≤ 1.0°`。
- 多次运行结果一致（抖动 < 0.1°）。

### 阶段 D：一致性与边界用例
- 验证以下场景：
  - 固定太阳模式 on/off；季节性 on（仅光照变化，不写地球）；PIP on/off。
  - 相机不挂地球组；星空不在地球组；切换场景时不丢姿态。
- 增补文档与 README 使用说明。

## 回退与风险控制
- 回退开关：`composition.enableBirthPointAlignment=false` 关闭出生对齐；`composition.useFixedSun=false` 关闭固定太阳；`composition.enablePIP=false` 关 PIP。
- 风险点：
  - 历史代码仍在某处写 `earthRoot`（隐性副作用）；
  - 直接操作相机的路径未收敛；
  - 贴图经纬/坐标口径不一致重新引入。
- 缓解：
  - 在关键写入点加入带调用栈的日志（可选 `console.trace()`）；
  - 在开发态对 `earthRoot.rotate*`、`quaternion.set` 做代理包装，记录来源（仅诊断环境）。

## 实施顺序与工时预估
- 阶段 A：0.5 天（代码收敛 + 日志）
- 阶段 B：0.5–1 天（依赖精简 + 统一控制）
- 阶段 C：0.5 天（诊断命令 + 文档）
- 阶段 D：0.5 天（一致性验证 + README）

## 验收清单（勾选）
- [ ] 出生对齐下无任何地球旋转写入
- [ ] 相机角度不被实时更新覆盖
- [ ] 诊断命令 `max(errorDeg) ≤ 0.5°`
- [ ] 固定太阳/季节/PIP 组合下表现一致
- [ ] 文档更新完成并与实现一致
