# 算法问题定位与建议（基于 log_chrome.md）

## 核心结论

- 方位角（Azimuth）在太阳接近天顶时出现数值不稳定，典型场景为“赤道春分当地中午”。高度角（Elevation）正确，但方位角明显偏离物理期望。
- 现有自动化校验仅验证高度角阈值，未覆盖方位角正确性，导致问题未被测试拦截。

## 关键证据（取自 log_chrome.md）

- quickTest 第 4 项：赤道春分中午
  - `结果: 高度角=88.17°, 方位角=72.83°`
  - 日地几何：在赤道春分“真正过中天”时，太阳应过顶（方位角无定义）；若以地方时 12:00 近似中天，则方位角应在子午线附近（0° 或 180°），而非 72.83°。
- SimpleTest（春分，经度 0，12:00）：
  - `Real sun angles from ephemeris: {azimuth: '72.8', altitude: '88.2'}`（与上面一致）
- 其他时刻结果正常，用作对照：
  - 春分 06:00：`azimuth: '79.6', altitude: '21.2'`（近东方位）
  - 夏至 12:00：`azimuth: '179.3', altitude: '47.4'`（近南方位）
  - 夏至 18:00：`azimuth: '279.6', altitude: '21.5'`（近西方位）
- 测试通过原因：
  - `✅ 赤道春分中午: 通过 (88.17° >= 80°)` —— 仅以高度角阈值判断，未校验方位角。

## 根因分析

- 数值奇点：当高度角→90° 时，水平投影→0，使用 atan2/球面三角公式反算方位角会放大浮点误差，方位角易产生任意漂移（即便高度角正确）。
- 参考系约定：日志显示方位角零点似以“东”为 0°（如日出 ≈ 90°）。若文档/认知默认“北为 0°”，会进一步造成观感偏差。需统一并文档化。
- 向量/角度不一致风险：`sunWorld` 与 `ephemeris` 的轴向约定可能不同（如 up/水平平面的定义），应统一 ENU（或项目既定）坐标到角度的映射关系，并加往返一致性检查。

## 影响范围

- 低纬地区或接近天顶的时段（Elevation > ~85°），依赖方位角的渲染、阴影方向、文字标注可能明显偏转；高度角表现正常。
- 自动化测试当前无法捕获此类边界场景的方位角问题。

## 修复建议

- 数值稳健性：
  - 当 Elevation > 85°（或水平投影 < 1e-3）时，将方位角视为未定义或保持上一帧稳定值；
  - 或改用基于“时角 HA”的稳健公式，避免直接由近零水平分量反推；
  - 对 atan2 输入做阈值钳制，减少抖动。
- 基准统一：
  - 明确“0° 指向”和角度正向（例如 北=0° 且顺时针为正，或 东=0° 亦可，但需项目一致且对外说明）。
- 向量到角度映射：
  - 统一 ENU/世界坐标与角度定义，新增断言：角→向量→角往返误差 < 0.5°（在非天顶区域）。
- 测试补充：
  - 为“赤道春分中午”“低纬高海拔”场景新增方位角断言；
  - 在 Elevation > 85° 时允许方位角为 undefined/沿用上一稳定值；
  - 对接近天顶的小范围时间扫描，校验方位角的平滑性与合理性。

## 参考校验

- 赤道春分“真中天”时，太阳过顶，方位角无定义；若以地方时 12:00 近似中天，方位角应落在子午线附近（0° 或 180°，视零点约定），而不是 72.8°。

## 下一步

- 确认并文档化项目的方位角零点与正向约定；
- 在 `ephemeris.ts` 的方位角计算处加入天顶阈值处理与注释；
- 扩充 `quickTest.ts`/`validation.ts` 的方位角校验用例；
- 可选：在 UI 上对“方位角未定义/不稳定”状态进行提示或图标化处理。

