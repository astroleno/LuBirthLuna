# 晨昏线问题修复总结

## 问题描述

用户报告：在上海时间晚上10点时，晨昏线显示"刚刚过晨昏线"而不是"深夜"，表明晨昏线位置不正确。

## 问题分析过程

### 1. 初步分析

- **太阳位置计算正确**：
  - 时间转换：上海22:08 → UTC 14:08 ✅
  - 太阳角度：方位角324.5°，高度角-47.6°（地平线下，符合夜晚）✅

- **疑似问题**：最初怀疑是光照方向与地球旋转不同步

### 2. 关键发现

通过深入分析代码，发现了根本问题：

**地球自转计算正确但未被应用！**

#### 时间计算修复
```typescript
// 修复前：使用本地时间（错误）
const earthRotation = (hours * 15 + minutes * 0.25) % 360;

// 修复后：使用UTC时间（正确）
const utcHours = now.getUTCHours();
const utcMinutes = now.getUTCMinutes();
const earthRotation = ((utcHours * 15 + utcMinutes * 0.25) + 180) % 360;
```

#### 地球旋转应用问题
- `earthYawDeg` 在实时更新中被正确计算
- 但只有在 `useFixedSun` 模式下，`AlignOnDemand` 组件才会应用地球旋转
- **关键问题**：地球的物理旋转没有被应用到渲染中

### 3. 重要认知纠正

**太阳光方向不需要旋转！** 

- 太阳在宇宙中位置固定
- 地球应该相对于固定太阳光旋转
- 晨昏线通过地球相对太阳的旋转位置计算

## 解决方案

### 1. 修复地球自转计算基础

**文件：** `src/SimpleTest.tsx` (第551-567行)

```typescript
// 🔧 修复地球自转计算 - 基于UTC时间而不是本地时间
const hours = now.getHours();
const minutes = now.getMinutes();
const utcHours = now.getUTCHours();
const utcMinutes = now.getUTCMinutes();
// GMT时间0点时，格林威治子午线朝向太阳，随时间向西旋转
// 但这里需要考虑贴图seam在变更线(180°)的问题
const earthRotation = ((utcHours * 15 + utcMinutes * 0.25) + 180) % 360;
updateValue('earthYawDeg', earthRotation);
```

**说明：**
- 使用UTC时间而非本地时间
- 添加180度补偿，因为贴图seam在变更线(180°经线)
- 现在UTC 14:08 → 地球自转角度 = 32度（正确）

### 2. 创建地球自转应用组件

**文件：** `src/SimpleTest.tsx` (第341-366行)

```typescript
// 🌍 地球自转组件 - 基于earthYawDeg应用地球旋转
function EarthRotation({ earthYawDeg }: { earthYawDeg: number }) {
  const { scene } = useThree();
  React.useEffect(() => {
    try {
      const earth = scene.getObjectByName('earthRoot');
      if (earth) {
        // 应用地球自转：绕世界Y轴旋转
        const worldUp = new THREE.Vector3(0, 1, 0);
        const rotationRad = THREE.MathUtils.degToRad(earthYawDeg);
        (earth as THREE.Object3D).quaternion.identity();
        (earth as THREE.Object3D).rotateOnWorldAxis(worldUp, rotationRad);
        
        if (logger.isEnabled()) {
          logger.log('earth-rotation', {
            earthYawDeg,
            rotationRad,
            note: '基于UTC时间的地球自转'
          });
        }
      }
    } catch (err) {
      console.error('[EarthRotation] Error:', err);
    }
  }, [earthYawDeg, scene]);
  return null;
}
```

### 3. 集成地球自转组件

**文件：** `src/SimpleTest.tsx` (第322-324行)

```typescript
{/* 🌍 地球自转系统 - 基于UTC时间 */}
<EarthRotation earthYawDeg={composition.earthYawDeg} />
```

## 修复逻辑说明

### 时间转换链条
1. **当前时间**：上海晚上10:08 (UTC+8)
2. **UTC时间**：14:08
3. **地球自转角度**：(14 × 15 + 8 × 0.25 + 180) % 360 = 32°
4. **物理意义**：格林威治子午线转过32°，约对应东经148°朝向太阳
5. **上海位置**：121.5°E，在晨昏线夜晚侧 ✅

### 坐标系统
- **太阳光方向**：世界坐标系固定方向（不旋转）
- **地球旋转**：绕世界Y轴旋转 `earthYawDeg` 度
- **晨昏线计算**：shader中通过 `dot(normal, lightDirection)` 计算
- **正确关系**：地球旋转 → 法线变化 → 晨昏线移动

## 预期效果

修复后应该看到：
1. **上海晚上10点**：处于夜晚区域（远离晨昏线）
2. **晨昏线位置**：与太阳的实际位置一致
3. **经线对齐功能**：也应该能正确工作（基于正确的地球-太阳关系）

## 技术要点

### 关键修复点
1. **时间基础**：使用UTC而非本地时间计算地球自转
2. **旋转应用**：确保 `earthYawDeg` 被实际应用到地球几何体
3. **坐标系统**：保持太阳光固定，让地球旋转

### 避免的错误认知
- ❌ 太阳光需要随地球旋转
- ❌ 光照方向需要变换到地球本地坐标系  
- ✅ 地球相对固定太阳光旋转
- ✅ 晨昏线通过地球旋转位置自然形成

## 文件变更清单

1. **`src/SimpleTest.tsx`**：
   - 修复实时地球自转计算（UTC时间基础）
   - 新增 `EarthRotation` 组件
   - 集成地球自转系统

## 测试验证

修复完成后需要验证：
- [ ] 上海晚上10点时处于深夜区域
- [ ] 晨昏线位置与理论太阳位置匹配
- [ ] 经线对齐功能正常工作
- [ ] 实时时间变化时晨昏线正确移动