# 🚀 代码迁移TODO清单 - 方案2：重新构建新组件

 

## 📋 项目目标
将复杂的双光系统、分层渲染、月球烘焙系统简化为单光系统，保留所有核心视觉效果，提升代码可维护性。

## ⏰ 时间规划
- **第一阶段** (已完成): 项目设置、基础架构、核心组件
- **第二阶段** (已完成): 完整组件实现、UI完善
- **第三阶段** (进行中): 性能测试和优化

## 🏗️ 文件架构
```
src/
├── types/
│   └── SimpleComposition.ts          ✅ 简化的构图参数类型
├── scenes/simple/
│   ├── utils/
│   │   ├── textureLoader.ts          ✅ 纹理加载工具
│   │   ├── positionUtils.ts          ✅ 位置计算工具
│   │   └── lightingUtils.ts          ✅ 光照计算工具
│   └── components/
│       ├── Earth.tsx                 ✅ 地球组件
│       ├── Moon.tsx                  ✅ 月球组件
│       ├── Clouds.tsx                ✅ 云层组件
│       ├── AtmosphereEffects.tsx     ✅ 大气效果组件
│       └── SimpleEarthMoonScene.tsx  ✅ 主场景组件
├── SimpleTest.tsx                    ✅ 完整测试组件
└── App.tsx                           ✅ A/B测试支持
```

## 🎯 优先任务清单

### ✅ 已完成任务

#### 1. 项目设置和架构
- [x] 创建项目目录结构
- [x] 备份原始Scene.tsx
- [x] 创建SimpleComposition类型定义
- [x] 实现A/B测试支持

#### 2. 工具文件
- [x] **textureLoader.ts** - 纹理加载工具
  - 支持可选纹理加载
  - 支持首选可用纹理
  - Kelvin到RGB色温转换
- [x] **positionUtils.ts** - 位置计算工具
  - 相机控制
  - 地球位置计算
  - 月球位置计算
  - 曝光控制
- [x] **lightingUtils.ts** - 光照计算工具
  - 单光照方向计算
  - 光照颜色和强度
  - 环境光强度
  - 夜景强度

#### 3. 核心组件
- [x] **Earth.tsx** - 地球组件
  - 完整移植earthDNMaterial着色器
  - 支持昼夜过渡效果
  - 支持高光和材质参数
- [x] **Moon.tsx** - 月球组件
  - 标准MeshStandardMaterial
  - 支持位移贴图
  - 移除复杂烘焙系统
- [x] **Clouds.tsx** - 云层组件
  - 完整移植CloudsLitSphere着色器
  - 支持云层旋转和高度调整
  - 支持Gamma、黑白点、对比度控制
  - 包含CloudsOverlayFix增强效果
- [x] **AtmosphereEffects.tsx** - 大气效果组件
  - 完整移植rimMaterial大气弧光
  - 完整移植earthGlowMaterial地球辉光
  - 支持强度和高度参数调整

#### 4. 主场景组件
- [x] **SimpleEarthMoonScene.tsx** - 主场景
  - 集成所有子组件
  - 统一光照系统
  - 相机和位置控制

#### 5. 测试和UI
- [x] **SimpleTest.tsx** - 完整测试组件
  - 与原版本一致的UI设计
  - 完整的参数控制面板
  - 支持所有视觉效果调整
  - 相机锁定功能（保持理想构图）

### 🔄 进行中任务

#### 6. 性能测试和优化
- [ ] 帧率性能测试
- [ ] 内存使用优化
- [ ] 渲染管线优化
- [ ] 移动设备兼容性测试

## 🚀 渐进式迁移策略

### 阶段1: 基础架构 ✅
- 创建简化的类型定义
- 实现核心工具函数
- 建立组件架构

### 阶段2: 核心功能 ✅
- 实现地球、月球、云层、大气效果
- 完善单光照系统
- 创建完整测试场景

### 阶段3: 优化和部署 🔄
- 性能测试和优化
- 最终集成测试
- 生产环境部署

## 🛠️ 技术实现细节

### 光照系统
- **单光照**: 移除双光系统，使用统一的方向光
- **色温控制**: 支持2000K-10000K色温调节
- **强度控制**: 支持0-6倍光照强度
- **方向控制**: 支持方位角和仰角调节

### 材质系统
- **地球材质**: 保留昼夜过渡着色器
- **月球材质**: 简化为标准材质+位移贴图
- **云层材质**: 保留完整着色器效果
- **大气材质**: 保留弧光和辉光效果

### 位置系统
- **地球位置**: 支持大小、倾角、自转控制
- **月球位置**: 支持距离、半径、经纬度调整
- **相机控制**: 锁定相机位置，保持理想构图

## 🎨 视觉效果保留

### ✅ 保留效果
- 地球昼夜过渡
- 云层渲染和材质
- 大气弧光效果
- 地球辉光效果
- 星空背景
- 银河星空贴图

### ❌ 移除效果
- 双光照系统
- 分层渲染
- 月球烘焙系统
- 月球包裹球
- 双通道渲染

## 📊 代码简化统计

### 原始Scene.tsx
- **总行数**: ~1000行
- **复杂度**: 高（双光、分层、烘焙）

### 简化后
- **总行数**: ~500行
- **复杂度**: 中（单光、统一渲染）
- **简化程度**: 50%

### 组件化收益
- **可维护性**: 大幅提升
- **代码复用**: 支持
- **测试便利性**: 支持
- **性能**: 预期提升

## 🎯 成功指标

### 功能完整性
- [x] 所有核心视觉效果正常
- [x] 单光照系统工作正常
- [x] 参数控制完整可用
- [x] UI界面美观易用

### 性能指标
- [ ] 帧率 ≥ 60fps
- [ ] 内存使用 ≤ 200MB
- [ ] 加载时间 ≤ 3秒

### 代码质量
- [x] TypeScript类型完整
- [x] 组件化架构清晰
- [x] 错误处理完善
- [x] 注释文档完整

## 🚧 风险控制

### 技术风险
- **着色器兼容性**: 已通过完整移植解决
- **性能影响**: 通过组件化优化
- **浏览器兼容性**: 使用标准Three.js API

### 功能风险
- **视觉效果丢失**: 通过详细对比验证
- **参数控制缺失**: 通过完整UI实现
- **交互体验下降**: 通过相机锁定保持

## 📝 更新日志

### 2024-12-19
- ✅ 完成SimpleTest.tsx UI完善
- ✅ 添加缺失的控制参数（地球位置、云层黑白点等）
- ✅ 实现相机锁定功能，保持理想构图
- ✅ 修复所有类型错误
- ✅ 改善UI排列和美观性
- ✅ 代码构建成功
- ✅ 添加地球和月球单独光照控制（强度、方位角、仰角、色温）
- ✅ 修复地球辉光显示问题，参考原版本着色器实现
- ✅ 完善光照系统架构，支持独立控制
- ✅ 恢复原来的地球弧光实现（rimMaterial）
- ✅ 保持原来的地光实现（earthGlowMaterial）
- ✅ 移除错误添加的多个光源，恢复单光照系统
- ✅ 在材质层面添加色温和亮度控制参数
- ✅ 完全恢复原版本的三层大气效果架构
- ✅ 添加rimRadius和haloWidth精细控制参数
- ✅ 恢复弧光贴合半径差和近表面软光晕效果
- ✅ 添加地球和月球材质亮度与色温控制
- ✅ 修正rimRadius范围为0.001-0.01
- ✅ 添加保存默认参数和重置按钮
- ✅ 实现地球材质亮度与色温控制（在着色器中应用）
- ✅ 修复地球辉光物理规律（日侧亮，夜侧暗，从地表向外渐变）
- ✅ 修复弧光贴合控制参数缺失问题
- ✅ 增强地球辉光效果（调整默认值、优化着色器参数）
- ✅ 完善三层大气效果控制（rimRadius、haloWidth、earthGlow）
- ✅ 新增UI控制：rimRadius (0.001-0.01)、haloWidth (0.001-0.05)
- ✅ 修复AtmosphereEffects参数传递：补充rimRadius/haloWidth
- ✅ 增强地球辉光默认值：earthGlowStrength=0.8, earthGlowHeight=0.05
- ✅ 优化earthGlow着色器：降低Fresnel与径向衰减指数，增强日侧权重
- ✅ Earth材质：在earthDN着色器中接入亮度与色温（并保证uniform动态更新）
- ✅ 重新实现地球辉光效果：从地表向外渐变，避免"盖布"效果
- ✅ 恢复原版本有效的地球辉光着色器实现
- ✅ 修复UI控制范围：辉光强度0-3，高度0.001-0.2
- ✅ 简化地球辉光着色器：确保基本效果可见，修复距离计算
- ✅ 重新实现地球辉光：圆环状辉光，从地球表面向外扩散的发光圆环
- ✅ 修复地球辉光参数传递问题：earthGlowDayNightRatio正确解构
- ✅ 重新实现地球辉光：日全食效果的外层光环，从地球表面向外扩散的圆形光环
- ✅ 重新实现地球辉光：真正做成从地球表面向外扩散的日食环效果，不是围绕地球的圆环
- ✅ 重新实现地球辉光：做成真正的日食环效果，从地球边缘透出的光芒，不是围绕地球的圆环
- ✅ 回到简单辉光实现：确保基本效果可见，最小alpha值设为0.3

### 2024-12-19 上午
- ✅ 完成所有核心组件实现
- ✅ 创建完整的SimpleEarthMoonScene.tsx
- ✅ 实现云层和大气效果组件
- ✅ 更新SimpleTest使用完整组件

### 2024-12-19 凌晨
- ✅ 完成月球组件功能
- ✅ 实现云层组件
- ✅ 实现大气效果组件
- ✅ 创建完整的SimpleEarthMoonScene.tsx

### 2024-12-18
- ✅ 完成项目设置和基础架构
- ✅ 实现核心工具文件
- ✅ 完成地球组件
- ✅ 实现A/B测试支持

## 🔮 下一步计划

### 立即执行
1. **性能测试和优化** 🔄
   - 帧率性能测试
   - 内存使用分析
   - 渲染管线优化

### 后续计划
2. **最终集成测试**
3. **生产环境部署**
4. **用户反馈收集**

## 💡 技术亮点

1. **单光照系统**: 简化复杂的光照逻辑，提升性能
2. **组件化架构**: 清晰的代码结构，易于维护
3. **完整参数控制**: 保留所有视觉效果调节能力
4. **相机锁定**: 保持理想构图，避免用户误操作
5. **渐进式迁移**: 支持A/B测试，降低部署风险

## 🚀 后续开发计划（基于advice4/5建议）

### 📋 **采纳的架构建议**

#### 1. 世界系固定太阳方向 ✅ (推荐采纳)
- **目标**: 太阳光固定在世界坐标系，不随构图旋转
- **好处**: 昼夜始终正确，月相物理真实
- **实现**: 
  - 接入 `computeEphemeris(date)` 计算世界系太阳方向
  - `directionalLight` 挂载在 world 根节点，不进 ShotRig
  - 所有材质统一使用 world-space 的 `sunDirWorld`

#### 2. ShotRig构图系统 ✅ (推荐采纳)
- **目标**: 地球+相机联动，光独立，构图可控
- **好处**: 实现"出生点→北极附近"对准，保持理想构图
- **实现**:
  - 创建 `ShotRig` Group，包含 Earth + 主相机
  - 四元数旋转：`u_obs → u_target(80°N, 180°)`
  - 相机微调锁定构图

#### 3. 月球画中画系统 ✅ (推荐采纳)
- **目标**: 真实月相，独立渲染，不影响主画面
- **好处**: 月相物理正确，可独立艺术控制
- **实现**:
  - `Moon_phys` 世界系放置，潮汐锁定到地球
  - `C_phys` 第二镜头，只看月球图层
  - 画中画渲染：主屏(地球) + 小窗(月球)

### 🎯 **具体实现任务**

#### 第一阶段：世界系太阳方向
- [ ] 接入 `computeEphemeris(date)` 天文解算
- [ ] 重构光照系统：世界系固定，材质共享 `sunDirWorld`
- [ ] 测试昼夜正确性（地球不动，光照变化）

#### 第二阶段：ShotRig构图系统  
- [ ] 引入 `ShotRig` Group 架构
- [ ] 实现"出生点→(80°N,180°E)"对准
- [ ] 相机构图锁定与微调

#### 第三阶段：月球画中画
- [ ] 创建 `Moon_phys` 真实月球（世界系）
- [ ] 实现潮汐锁定：月球前向始终朝地球
- [ ] 创建 `C_phys` 观测者镜头
- [ ] 画中画渲染：双视口 + 圆形蒙版

#### 第四阶段：艺术控制与优化
- [ ] 月球独立参数：EV、色温、色偏、地照
- [ ] PABL计算：亮缘位置角精确校准
- [ ] 性能优化：小窗分辨率自适应、近新月保护

### 🔧 **技术要点**

#### 坐标系约定
- **World/Astro**: 固定世界系（太阳方向计算）
- **ShotRig**: 构图系（地球+相机联动）
- **一致性**: 所有着色器使用 world-space `sunDirWorld`

#### 渲染流程
- **Pass A**: 主屏渲地球（Layer0）
- **Pass B**: 小窗渲月球（Layer1，清深度）
- **共享**: toneMapping/exposure/outputColorSpace

#### 稳定性保障
- 近新月防抖（冻结roll或淡出）
- 清深度避免遮挡
- DPR像素对齐
- 无后处理管线，实时稳定

### 📅 **时间评估**
- 世界系太阳方向：0.5天
- ShotRig构图系统：0.5天  
- 月球画中画：1天
- 艺术控制优化：0.5天
- **总计**: 2.5天

### 🎨 **预期效果**
- **天文正确**: 太阳方向世界系固定，昼夜/月相自动正确
- **构图可控**: ShotRig一次旋转即可对准理想构图
- **实时稳定**: 画中画同帧更新，不受主镜头影响
- **艺术可调**: 月亮亮度/色温/色偏/地照全部独立调节

---

**项目状态**: 🟢 第二阶段完成，第三阶段进行中  
**完成度**: 85%  
**下一步**: 性能测试和优化
