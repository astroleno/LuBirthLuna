## LuBirth 可视化增强 · 计划实现表

版本: v0.1 · 更新: 2025-09-11 · 负责人: （待填）

### 目标
- 提升“第一眼观感”和稳定帧率，优先落地对画质显著的改进。
- 保持与固定太阳模式/自动化测试兼容，不破坏既有物理正确性与渲染顺序约束。

### 范围
- 地球大气与终止线、海面高光、云层动画、夜景城市、色调映射/Bloom、分层大气、星空背景、PIP 性能。

---

## 独立开发与参数化接入约定（并行不侵入）

- 总原则：新增能力均以“附加组件/后期节点/材质扩展函数”的形式交付；仅依赖只读输入参数与本地内部状态，不修改主工程公共状态与层级关系；通过 `SimpleComposition` 特性开关启用/关闭；关闭后完全还原现状。

- 大气辉光基础/近地渐变（组件）
  - 输入：`earthRadius:number`、`lightDirection:THREE.Vector3`、`intensity:number`、`thickness:number`、`color`、`visible:boolean`、`renderOrder?:number`
  - 边界：`transparent+Additive+BackSide`、`depthWrite=false`；仅渲染自身球壳，不改主材质。

- 终止线柔化/色温（材质扩展或后期近似）
  - 输入：`terminatorSoftness:number`、`nightFalloff:number`、`terminatorLift:number`、`terminatorTint:[r,g,b,a]`
  - 边界：优先提供“后期近似”版本以免改动主着色器；材质扩展版以可选函数注入，默认不启用。

- 海面高光 × 菲涅尔（材质扩展）
  - 输入：`specFresnelK:number`（0 关闭）
  - 边界：以函数形式对现有 `specCol` 乘权；默认不启用，便于并行开发。

- 云层慢速滚动（组件内部 UV 偏移）
  - 输入：`cloudScrollSpeedU:number`、`cloudScrollSpeedV:number`
  - 边界：仅改自身 UV，不改姿态与父级四元数，避免与对齐系统冲突。

- 色调映射 + Bloom（后期管线）
  - 输入：`enableToneMap:boolean`、`enableBloom:boolean`、`bloomThreshold:number`、`bloomStrength:number`、`exposure:number`
  - 边界：独立后期节点，默认关闭；不改变自动化测试的数值路径。

- 分层大气（组件）
  - 输入：`enableLayeredAtmo:boolean`、`layers: {height:number,color,intensity,scattering}[]`
  - 边界：多个内表面球壳叠加，遵循透明排序；不改主材质。

- 星空/银河（Skybox 组件）
  - 输入：`enableStarfield:boolean`、`starIntensity:number`
  - 边界：不挂地球组；只读依赖相机；开关控制可见性。

- PIP 性能优化（离屏渲染节点）
  - 输入：`pip.resolution:number`、`pip.fps:number`、`pip.dynamicQuality:boolean`、`pip.sharpen:number`
  - 边界：独立渲染目标；默认参数不改变主帧时间；关闭即移除。

- 地球法线增强（材质可选项）
  - 输入：`enableEarthNormalMap:boolean`、`earthNormalScale:number`
  - 边界：仅在启用时采样 normalMap 扰动法线；默认关闭，无副作用。

目录建议：`src/visual/addons/*`（组件/后期/材质扩展分目录），主工程在 `SimpleTest`/`Earth` 处“按需引入 + 传参”。

---

## 阶段与里程碑（建议 1–2 周）

- M1 即刻提升（1–3 天）
  - 基础：大气辉光优化、终止线柔化增强、海面高光加菲涅尔、云层慢速滚动、可选轻量色调映射/Bloom。
- M2 质感跃迁（3–7 天）
  - 分层大气（2–3 层）、星空/银河升级、PIP 性能优化、可选地球法线贴图。
- M3 稳态一致性与回归（持续）
  - LOD 与距离裁剪、纹理压缩/缓存、性能快照对比、文档与开关说明更新。

---

## 任务清单（优先级 A/高 → B/中 → C/低）

### A1 大气辉光“更自然”与近地渐变（基础版）
- 目的: 让边缘晕光更柔，且具备从地表向空中的厚度感（非体积版）。
- 变更: 
  - 调整 `rimMaterial` 的 Fresnel 曲线与宽度曲线；
  - 增加一层“近地薄壳”渐变（radius ≈ size*(1+0.02~0.06)），透明度随法线与视角、光照共同衰减；
  - RenderOrder 高于地表、低于 Bloom。
- 开关/参数: `enableAtmosphere`(bool, 默认开)、`atmo.intensity`(0–2, 默认1.0)、`atmo.thickness`(0.02–0.08, 默认0.05)、`atmo.color`(RGB)。
- 文件: `src/scenes/simple/api/components/AtmosphereEffects.tsx`（或新建 `components/EarthAtmosphere.tsx`）。
- 验收: 近景与远景边缘平滑无硬线；昼侧更亮、夜侧更弱；主帧 +≤1.5ms。
- 回退: `enableAtmosphere=false` 关闭；保留原有单层辉光参数。

### A2 终止线（晨昏线）柔化与暖色偏移
- 目的: 让日夜交界从“干净硬切”变为“自然软过渡”，加入暖色调。
- 变更: 扩大 `edge` 范围、加入 `nightFalloff` 的可调区间；在交界带叠加微暖色 `terminatorTint`。
- 开关/参数: `terminatorSoftness`、`nightFalloff`、`terminatorLift`、`terminatorTint=[r,g,b,a]`（默认轻微）。
- 文件: `src/scenes/simple/api/components/Earth.tsx`（片段着色器）。
- 验收: 0/30/60° 太阳高度下边界无明显带状伪影；高纬也稳定；性能 +≤0.5ms。
- 回退: 恢复默认参数（tint α=0）。

### A3 海面镜面高光 × 菲涅尔
- 目的: 高光随观察角增强，呈“亮带”，更接近水体。
- 变更: 在 `specCol` 上乘 `fresnel = pow(1 - dot(V,N), k)`，k∈[1.0,3.0]；可加轻度粗糙度噪声。
- 开关/参数: `specFresnelK`（默认1.8）、`specStrength`、`shininess`、`broadStrength`。
- 文件: `src/scenes/simple/api/components/Earth.tsx`（片段着色器）。
- 验收: 仅昼侧可见；角度变大时高光增强且不过曝；+≤0.3ms。
-回退: `specFresnelK=0`。

### A4 云层慢速滚动（非姿态旋转）
- 目的: 维持姿态控制稳定的同时，提供“呼吸感”。
- 变更: 在云层着色器中以时间微量偏移 UV（如 `uv.x += t*0.002`），或在纹理采样前加小幅噪声偏移；禁用 `useFrame` 旋转。
- 开关/参数: `cloudScrollSpeedU/V`（默认极慢 0.001~0.003）。
- 文件: `src/scenes/simple/api/components/Clouds.tsx`。
- 验收: 1 分钟肉眼可感位移，无拉扯/缝合；姿态对齐不受影响；+≤0.3ms。
- 回退: `cloudScrollSpeedU=cloudScrollSpeedV=0`。

### A5 轻量色调映射 + 温和 Bloom（可选默认关）
- 目的: 统一明暗层次，避免“过灰/过爆”；晕光更自然。
- 变更: 引入简单色调映射（Reinhard/ACES 近似）与低阈值弱 Bloom；提高暗部可读性。
- 开关/参数: `enableToneMap`、`enableBloom`、`bloomThreshold`、`bloomStrength`、`exposure`。
- 文件: 新建后期节点（基于 `@react-three/postprocessing` 或自定义）；不影响自动化测试数值路径。
- 验收: 默认关；打开时截图显著更协调；主帧 +≤1.2ms（1080p）。
- 回退: 关闭开关即还原。

### B1 分层大气（2–3 层）
- 目的: 形成近地蓝、上层深蓝/靛蓝的层次感，增强真实度。
- 变更: 叠加 2–3 个后面朝内的球壳，分别控制颜色、强度、散射指数、厚度；与 A1 协同。
- 开关/参数: `enableLayeredAtmo`、`layers:[{height,color,intensity,scattering}]`。
- 文件: 新建 `components/LayeredAtmosphere.tsx`；在 `SimpleTest` 中通过 composition 控制。
- 验收: 远近一致、无闪烁；主帧 +≤1.5ms；无排序穿插。
- 回退: `enableLayeredAtmo=false` 回退到 A1 基础版。

### B2 星空/银河背景升级（独立于地球组）
- 目的: 提升深空层次与沉浸感。
- 变更: 更高分辨率 Milky Way/星野纹理、渐变光污染校正；保持不挂地球组。
- 开关/参数: `enableStarfield`、`starIntensity`。
- 文件: `src/scenes/simple/.../Skybox.tsx`（若无则新建）。
- 验收: 地球自转时星空不跟随；噪点低；性能开销可忽略。
- 回退: 关闭开关。

### B3 PIP 取景性能与清晰度优化
- 目的: PIP 不拖慢主帧，同时保持可读性。
- 变更: 离屏渲染降帧/降分辨率自适应、锐化轻滤镜、按 FPS 动态调整。
- 开关/参数: `pip.resolution`、`pip.fps`、`pip.sharpen`、`pip.dynamicQuality`。
- 文件: `src/SimpleTest.tsx` 内 PIP 模块。
- 验收: 开启 PIP 主帧 +<2ms；清晰可读；与自动测试兼容。
- 回退: `enablePIP=false`。

### B4 地球法线贴图（可选）
- 目的: 提升地表微细节在斜光下的质感（不做位移）。
- 变更: 在 `Earth.tsx` 片段中加入可选 `normalMap` 采样并扰动法线；默认关。
- 开关/参数: `enableEarthNormalMap`、`earthNormalScale`。
- 文件: `src/scenes/simple/api/components/Earth.tsx`。
- 验收: 近景斜光处细节增强；+≤0.6ms；无接缝伪影。
- 回退: 关闭开关即移除影响。

### C1 氛围完善与稳态
- LOD/距离裁剪: 远距离关闭大气与云层叠加；
- 纹理压缩（KTX2）与缓存；
- 性能快照: 记录 FPS、ms、DrawCalls、Tris，纳入 `runSolarFullTests()` 输出。

---

## 开关命名建议（与 URL/控制台对齐）

- 大气层: `enableAtmosphere`、`atmo.intensity`、`atmo.thickness`、`atmo.color`、`enableLayeredAtmo`、`atmo.layers[]`。
- 终止线: `terminatorSoftness`、`nightFalloff`、`terminatorLift`、`terminatorTint`。
- 海面: `specFresnelK`（0 关闭）。
- 云层: `cloudScrollSpeedU`、`cloudScrollSpeedV`。
- 后期: `enableToneMap`、`enableBloom`、`bloomThreshold`、`bloomStrength`、`exposure`。
- 星空: `enableStarfield`、`starIntensity`。
- PIP: `pip.resolution`、`pip.fps`、`pip.dynamicQuality`、`pip.sharpen`。
- 地球法线: `enableEarthNormalMap`、`earthNormalScale`。

（建议在 `SimpleComposition` 增补字段；在 `SimpleTest` 注入控制台方法与 URL 解析：`?atmo=1&bloom=1&specF0=1.8` 等）

---

## 验收口径（统一）

- 观感: 近/远景边缘平滑；晨昏线自然；海光具角度性；云层缓动不跳动；星空不随地球转。
- 物理一致性: 不改动固定太阳 yaw 锁定与 `alignLongitudeOnly()` 顺序；光照向量使用“从太阳射向地球”。
- 性能: 1080p 目标 60fps；每项新增 +帧时预算见任务条目，累计不超 3–4ms。
- 回归: `runSolarAutoTests()` 与 `runSolarFullTests()` 输出正常；新增“性能快照”日志段。

---

## 风险与回退

- 风险: 渲染顺序/透明叠加导致的穿插或闪烁；云层动画与姿态控制冲突；后期影响色值路径。
- 缓解: 固定 `renderOrder`；透明材质 `depthWrite=false`；云层仅做 UV 滚动；后期默认关闭并可一键还原。
- 回退: 所有功能均有独立布尔开关；参数置 0 即可恢复旧观感。

---

## 排期建议（示例）

- D1: A1/A2/A3（核心视觉三件套）
- D2: A4/A5（云滚动、后期可选）
- D3–D5: B1/B2（分层大气、星空）
- D6–D7: B3/B4 与 C1（PIP、法线、稳态）

（每日提交包含：开关默认值、性能快照、对比截图、简要变更记录）


