# 🌍 云层厚度融合方案（A + B）—— 地月合照项目专用

---

## ✅ 方案概述

**目标：**

* 使用已有 **8K 云层贴图**
* 提供真实的 **云层厚度感**
* 同时兼顾 **近景细节 + 全局结构 + 性能优化**

---

## 🧩 组成结构

| 部分        | 实现方式        | 技术方案 | 用途                         |
| --------- | ----------- | ---- | -------------------------- |
| 🌐 全球云层   | 多层球体        | 方案 B | 模拟地球周围厚云感，适合中远景            |
| 🔍 局部近景补丁 | 动态 patch 云体 | 方案 A | 贴近摄像机方向，用 displacement 伪体积 |

---

## 🎯 技术融合细节

### 🌐 全局云层（方案 B）

```js
const cloudTexture = new THREE.TextureLoader().load('clouds_8k.png');
const numLayers = 5;
const baseRadius = earthRadius + 0.01;

for (let i = 0; i < numLayers; i++) {
  const radius = baseRadius + i * 0.002;
  const geometry = new THREE.SphereGeometry(radius, 128, 128);
  const material = new THREE.MeshStandardMaterial({
    map: cloudTexture,
    transparent: true,
    opacity: 0.1 + 0.05 * i,
    displacementMap: cloudTexture,
    displacementScale: 0.0005 * i,
    depthWrite: false,
    side: THREE.DoubleSide,
  });
  const cloudShell = new THREE.Mesh(geometry, material);
  scene.add(cloudShell);
}
```

> 💡 重点提示：
>
> * 多层球体使用相同贴图，叠加出体积感
> * 透明度和 displacement scale 渐变，让厚度更自然
> * 禁用 `depthWrite` 避免遮挡错误

---

### 🔍 局部近景 patch（方案 A）

```js
const patchGeo = new THREE.SphereGeometry(0.15, 128, 128);
const patchMat = new THREE.MeshStandardMaterial({
  map: cloudTexture,
  displacementMap: cloudTexture,
  displacementScale: 0.01,
  transparent: true,
  opacity: 0.8,
  side: THREE.DoubleSide,
  depthWrite: false,
});

const patchCloud = new THREE.Mesh(patchGeo, patchMat);
scene.add(patchCloud);
```

📌 **动态更新位置函数：**

```js
function updatePatchPosition(camera, earthRadius) {
  const direction = new THREE.Vector3();
  camera.getWorldDirection(direction);

  // 放到地球表面略上方
  const position = direction.clone().multiplyScalar(earthRadius + 0.03);
  patchCloud.position.copy(position);
  patchCloud.lookAt(camera.position);
}
```

📌 **调用方式：**

```js
function animate() {
  requestAnimationFrame(animate);

  updatePatchPosition(camera, earthRadius);
  renderer.render(scene, camera);
}
```

---

## 🧠 可选增强技巧

| 技术                      | 效果                    |
| ----------------------- | --------------------- |
| Shader alpha fade（边缘透明） | 模拟云体边缘散射、模糊化          |
| 动态 light scattering     | 背光云边泛白，更真实            |
| 云图 noise 扰动（小范围）        | 近看防止“贴图感”，增加随机性       |
| 云 patch 缓动              | patch 不跟相机死锁，稍带滞后感更自然 |

---

## ✅ 总结

| 特性       | 效果                       |
| -------- | ------------------------ |
| 单一贴图复用   | 保证一致性与性能                 |
| 融合两种厚度表现 | 全局用多层堆叠，局部用 displacement |
| 动态响应视角   | 贴近观察时自动加强细节厚度感           |
| 可拓展性强    | 后期可以加 HDR 天空、太阳光散射、风动云等  |

---

