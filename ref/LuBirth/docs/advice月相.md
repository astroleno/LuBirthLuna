codex

先把物理和渲染逻辑说清，我们再决定怎么改。

关键事实

- 月相不是“月球自转导致的”，而是“太阳方向 vs 观察方向（地球→月球方向）”的夹角随时间变化导致的。
- 月球是潮汐锁定：它自转一圈所用时间 ≈ 公转一圈所用时间，所以“始终大致以同一面朝向地球”。这影响你看到的表面纹理朝向
（贴图的朝向/滚转），但不决定月相本身。
- 因此，要让月相在 PIP 正确随时间变化，最核心只有两点：
    - 光线方向 L(t) = −sunWorld(t)
    - 观察方向 V(t) = moonWorld(t)（地心→月球的单位向量），PIP 相机沿 −V(t) 看向原点

你提的“相机2始终对着月心并且和月球一起旋转”的理解里有两件事：

- “对着月心”对的：PIP 相机应当沿 −moonWorld 看向原点。
- “跟月球一起旋转”如果指“保持同一面朝向地球”，其实不需要相机去转，而是（可选地）让“月球网格的贴图朝向”潮汐锁定：始终
用月球局部坐标的某个轴对准 −moonWorld（或地球方向）。这只影响月表特征的朝向，不影响明暗分界线（相位）。

建议的最简正确方案（算法与实现层面）

- 场景唯一方向光 directionalLight 用真实太阳方向：L(t) = −sunWorld(t)
    - 这样 Moon（标准材质）受光就随时间变化，从而相位自然变化。
- 主画面“固定太阳模式”的稳定构图继续保留，但只影响“地球着色器使用的光向量”和“地球的对齐四元数”：
    - 地球着色器光向量用 fixedSunDir；
    - 通过 qSun 将地球转到 fixedSunDir 下；不要去改场景唯一灯光的方向。
    - 如此，Moon 用真实太阳光，地球用 fixedSunDir（在 shader 里），两者互不干扰，月相自然变化，主构图也稳定。
- PIP 相机2
    - 位置/朝向：C2(t) = −d · moonWorld(t)，lookAt(0,0,0)。d 由月球半径和 FOV 算出来，保证构图满框。
    - 可选“潮汐锁定贴图朝向”：把月球网格的某个局部轴对齐 −moonWorld(t)，保证“同一面朝向地球”（贴图不会慢慢滚转）。这
一步只改贴图朝向；对相位无影响，按需求决定要不要做。
    - 暗部提亮：只在 PIP 增加很小的环境光（Ambient，仅作用于 PIP），不改材质、不改场景灯光；滑条 0.0–0.2（建议 0.06–
0.12）。

这样做的好处

- 不用分层灯光也可行（更简单），但如果你想让主画面的 Moon 也跟真实太阳光一致，我们就保留一个主场景唯一灯光即可。
- 月相是否正确只由 L(t) 与 V(t) 决定；“潮汐锁定”只决定贴图朝向（视觉纹理方位），不是月相是否变化的必要条件。
- 你提出的“镜头2跟月球一起旋转”的诉求，本质是“想要画面里月表纹理稳定”，这属于贴图朝向/相机滚转（roll）问题，和月相渲
染独立。我们可以：
    - 方案A（常见）：固定相机 up（比如世界 +Y），不做滚转，纹理会有轻微滚动（更真实，有时会有月面天平动的感觉）。
    - 方案B（潮汐锁定观感）：让月球网格潮汐锁定（局部某轴对齐 −moonWorld），相机 up 也可以对齐到“月面北”方向，画面上
月面朝向不变。

请你拍板

- 灯光方案：要不要按上面的“唯一 directionalLight = −sunWorld”+“地球着色器用 fixedSunDir”的拆分？（我推荐）
- PIP 的“潮汐锁定观感”：要不要做贴图朝向锁定（只影响纹理朝向，不影响月相）？要就加；不要就保持当前相机 up 固定。
- 暗部提亮滑条默认值设多少（我建议 0.08 或 0.1）？

你确认后，我再按这个方案实现/回退，避免再出现“月相不变”的问题，同时不动材质。


glm

好的，我们先讨论！你提出的观点非常有意思：

  你的想法分析

  你说：
  月球的月相应该是自己围绕地球旋转产生的，但是月球自身不自转，所以我们的相机 
  2(用于产生pip的)应该始终对着月心并且和月球一起旋转。

  这个想法的合理性：

  1. 物理正确性：
    - ✅ 月球确实是潮汐锁定的，始终以同一面朝向地球
    - ✅ 月相变化是由于月球围绕地球公转时，太阳光照角度的变化
    - ✅ 从地球上看月球的视角应该是固定的（始终看到同一面）
  2. 当前实现的问题：
    - ❌ 现在的 MoonPIP 使用固定的 moonDir 向量
    - ❌ 没有考虑月球的真实轨道位置
    - ❌ 相机位置不是基于地球-月球的几何关系

  关键问题讨论：

  问题1：月球的轨道位置
  - 当前月球位置是基于屏幕位置计算的，不是基于真实轨道
  - 应该根据时间计算月球在轨道上的真实位置

  问题2：相机视角
  - 相机应该从"地球方向"看向月球，这样才能看到正确的月相
  - 现在的相机方向可能不是从地球视角看的

  问题3：月相计算
  - 月相应该基于太阳-地球-月球三者的几何关系
  - 现在可能只是简单地使用光照方向

  我的理解：

  你觉得应该如何改进？是：

  1. 方案A：计算月球的真实轨道位置，然后相机从地球位置看向月球
  2. 方案B：简化处理，让相机始终从一个固定方向（比如正对月球的一面）看月球
  3. 方案C：其他想法？