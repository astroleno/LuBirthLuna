# 工作流阐述（“稳妥 + 实时”的一套管线）

下述流程把**天文正确性**、**构图控制**与**画中画月相**三件事彻底解耦：

* 太阳方向固定在**世界系**（不跟镜头/构图转）；
* 地球/相机/展示月球放在**构图系 ShotRig**里联动；
* 真实月相由**第二镜头 C\_phys**在同帧实时采集，再以“画中画”叠到主屏；
* 整个流程单光源、实时、稳定。

---

## 0) 输入与坐标系

* 输入：出生地经纬度 `(lat, lon)`、日期时间（含时区）。
* 坐标系：

  * **World/Astro**：固定世界系（太阳方向在此系中计算与使用）。
  * **ShotRig**：`Earth + Moon_display + C_shot`（主镜头与用于构图的展示月球）归入此组做联动旋转；**太阳光不挂这里**。
* 一致性：所有着色器统一使用 **world-space** 的 `sunDirWorld`。

---

## 1) 天文解算（世界系）

* `computeEphemeris(dateTime)` →

  * `sunDirWorld`（单位向量，指向太阳）
  * `moonPosWorld`（月球地心向量；或近似方向 `moonDirWorld`）
* `directionalLight` 的朝向 = `sunDirWorld`（或将 target 指向该方向）；**光源挂在 World 根节点**。
* 这种设置保证：无论构图怎样转，昼夜/相位都不被拖走。

---

## 2) 出生点 → 屏幕“北极附近”构图（80°N, 180°经线）

目标：让**出生点**在屏幕中的地球“球面投影”上，落到你规定的视觉锚点（“北极附近”，这里约定为**地表目标点** `lat=80°N, lon=180°`）。

步骤：

1. 将 `(lat, lon)` 转为地心单位向量 `u_obs`（以当前 Earth 模型的本地坐标系为准）。
2. 将目标锚点 `(80°N, 180°)` 转为地心单位向量 `u_target`。
3. 求四元数 `q = setFromUnitVectors(u_obs, u_target)`。
4. **施加到 `ShotRig`**：`ShotRig.quaternion = q * ShotRig.quaternion`。

   * 这样“出生点”会被搬运至屏幕球的“北极附近”（你定义的目标点），**太阳方向未改**。
5. 根据预设（如“地球占屏 1/3、月亮右上”）微调 `C_shot` 的半径/俯仰/偏航（小角度），锁定构图。

> 注意：我们从不旋转太阳光；只是搬运“被拍的东西”（地月与镜头）。

---

## 3) 月球两套“角色”：展示月球 vs 真实月球

* **Moon\_display（主画面里的装饰/构图月球，可选）**

  * 放在 `ShotRig`；允许 **朝向相机**（billboard）+ 屏幕空间 roll 去配合构图。
  * 着色仍用 `sunDirWorld`，只是用于画面平衡（可以关掉不用）。

* **Moon\_phys（真实月球，仅供第二镜头 C\_phys 拍摄）**

  * 放在 World/或与地球同组，但**不在主镜头图层**；只让 C\_phys 看到。
  * **潮汐锁定到地球**（物理意义）：

    * 月球 +Z 指向 `toEarth = normalize(EarthPos - MoonPosWorld)`；
    * 这样其“近端”始终朝地球。
  * 月相正确性的来源：

    * 明暗线由 `N·L`（`L = sunDirWorld`）决定；
    * **第二镜头 C\_phys 放在“出生点上空”**（下节），因此看到的相位与真实观测一致；
    * 弯月“开口方向”（倾斜）自然由 Sun–Moon–Observer 的几何关系决定；若需精确，可计算 **PABL（亮缘位置角）** 并作为绕视线轴的补偿 roll。

---

## 4) 第二镜头 C\_phys（观测者镜头）

* 位置：`Cam_physPos = EarthCenter + u_obs * (R_earth + h)`（h 为地表上方高度，几十米\~几百米即可）。
* 朝向：`lookAt(Moon_phys.position)`，视轴穿过月球球心，小窗内的月投影天生为圆。
* 层：`C_phys` 只渲 **Moon\_phys 所在图层**；不会渲主场景的地球/UI。
* 这样，在**太阳方向不变**的前提下，**C\_phys 看到的月相 = 出生点真实可见的月相**；无需随镜头转动修改光。

> 解释“潮汐锁定不冲突”：Moon\_phys 对地潮汐锁定让“近端朝地”；C\_phys 在地球上，自然看到这面；相位只由 `sunDirWorld` 与视角夹角决定，和你如何旋转 `ShotRig` 无关。

---

## 5) 画中画叠加（实时、稳）

**推荐：单渲染器 · 双相机 · 双视口 + 圆形蒙版**

* **Pass A（主屏）**：

  * `renderer.setViewport(0,0,W,H)`；渲 Layer0（Earth, UI, 可选 Moon\_display） 用 `C_shot`。
* **Pass B（小窗）**：

  * `renderer.clearDepth()`；
  * 设置小窗 `setViewport(x,y,w,h)` 与 `setScissor(x,y,w,h)`（四参按 dpr 取整像素）；
  * 渲 Layer1（**仅 Moon\_phys**）用 `C_phys`；
  * 在月球材质/覆盖片元中做**屏幕空间圆形蒙版 + 羽化**（1–2% 半径）。
* 共享 `toneMapping / exposure / outputColorSpace`，保证主/小窗观感一致。
* 小窗位置、大小、羽化实时可调；完全不受 `C_shot` 运动影响。

> 若要**极致解耦**：可改“**双 Canvas + CSS 圆裁切**”（主画布 + 仅月亮的小画布叠放），但需手动对齐 toneMapping/曝光。

---

## 6) 月亮颜色/亮度的艺术控制（仅作用于 Moon\_phys）

在 **Moon\_phys 材质**里提供独立参数（线性空间应用，进入 tone mapping 前）：

* `moonExposureEV`：曝光增益（`color *= exp2(EV)`，-4..+4）
* `moonTint` + `tintStrength`：色偏（冷暖/风格化）
* `moonTempK`（可选）：色温（黑体近似乘到入射光或最终颜色）
* `earthshineGain`（可选）：新月时加一点地照（灰蓝柔和）

> 这些调节只影响 **C\_phys 的月亮**，不动地球/主场景；实时无延迟。

---

## 7) 稳定性与容错

* **近新月防抖**：当太阳在 C\_phys 屏面的投影几乎为零，PABL/roll 抖动 → 冻结上一帧 roll 或直接淡出（<1% 人眼几乎看不到月）。
* **清深度**：小窗 pass 前 `clearDepth()`，避免被主画面前景深度挡住。
* **整数像素**：小窗视口/裁剪按 dpr 取整；圆边用 smoothstep 羽化，消锯齿与压缩伪影。
* **性能档**：小窗尺寸 256–512px（可自适应）；整帧无额外后期，实时稳定。

---

### 小结

* **太阳光**：世界系固定（天文解算），永不随构图旋转。
* **构图**：用 `ShotRig` 搬运地月与主镜头，把**出生点**放到屏幕球的指定锚点（80N, 180）。
* **真实月相**：Moon\_phys + C\_phys 在同帧采集；潮汐锁定到地球 + 世界系光照 → 相位与亮缘倾角自然正确。
* **画中画**：双视口圆形叠加，实时、稳、不受主镜头影响；月亮的亮度/颜色独立可调。

> 如果这套思路 OK，下一步我给出**技术实现清单/伪代码骨架**（相机/图层/视口设置、PABL 计算要点、材质参数插口与渲染顺序）。
