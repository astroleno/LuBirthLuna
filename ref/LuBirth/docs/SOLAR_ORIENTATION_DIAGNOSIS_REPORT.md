# 太阳朝向失灵 - 全面诊断与修复建议

本文档归档了当前“固定相机 + 地球构图保持 + 旋转太阳（或世界光照向量）”链路的失灵原因分析、影响评估与修复计划。

## 根因总结

- 恒星时/时角计算错误（核心根因）
  - 位置：`src/astro/ephemeris.ts` 的 `solarAltAz`。
  - 问题：使用了小时制常量 `T0/T1/T2` 且将“每日自转增量”写成了约 `0.0657 小时/天`，缺少 24 倍，导致格林威治平恒星时（GMST）随天数推进过慢；由此当地恒星时（LST）与太阳时角 `H` 基本不随日内时间变化，太阳在一天内几乎“静止”。
  - 现象：无论输入时间如何变化，太阳方位/高度变化异常缓慢或完全不动，表现为“完全失灵”。

## 次要与系统性问题

- 方位角与坐标约定需统一校验：
  - 目前 Alt/Az 定义为“方位 az: 北=0°、顺时针”，ENU→ECEF 映射正确，`-sunWorld` 作为光照方向正确。
  - 建议方位角改用标准公式：`atan2(sin(H), cos(H)*sin(lat) - tan(dec)*cos(lat))`，并统一归一到 [0,360)。

- 时区与本地时间解释：
  - `toUTCFromLocal` 用 `round(lon/15)` 估算时区，适用于“理想地理时区”，但与现实政治时区/夏令时存在差异。
  - UI 目前混用“本机当前时间”与“出生地经度时区”解释，可能造成小时级偏差。
  - 建议在 UI 增加“时间解释模式”开关（按经度/按系统时区），并在日志中清楚标注。

- Legacy 路径一致性：
  - 旧 `App.tsx` 中 legacy 模式引用了 `sunEQD/moonEQD`，而新版 `computeEphemeris` 返回 `sunWorld/moonWorld`。默认走 `SimpleTest` 不受影响，但后续启用 legacy 时需统一字段或移除旧入口。

## 修复策略（分阶段）

1) 核心修复 — GMST/LST：
   - 改为标准角度公式：`θ₀ = 280.46061837 + 360.98564736629 * (JD - 2451545.0)`；
   - LST：`LST = θ₀ + lonDeg`，均规一到 [0,360)；
   - 时角：`H = LST(rad) - α`，规一到 [-π, π]。

2) 方位角公式标准化（建议）：
   - 采用 `atan2(sin(H), cos(H)*sin φ - tan δ * cos φ)`，避免象限二义性。

3) 验证与回归：
   - 春分/夏至/冬至：上海 06/12/18/00；
   - 北极圈 66.55°N 夏至 00:00（午夜太阳>0°）；
   - 赤道春分 12:00（仰角接近 90°±1°）；
   - 同一时刻全球一致性：不同地点算出的 ECEF `sunWorld` 方向一致（容许浮点误差）。

4) 交互与鲁棒性：
   - UI 增加“时间解释模式”；
   - 保留向量归一/极端容错与关键日志。

## 影响评估

- 修复 GMST/LST 后，日内太阳方向将按实际天文速率变化，整体视觉效果立即恢复；
- 方位角公式标准化可减少高纬与日出日落附近的象限误判；
- UI 时间解释清晰后，可降低用户误用导致的小时级偏差。

## 附：当前链路概览

- 输入：出生地纬经度、本地时间（字符串）
- 转换：`toUTCFromLocal` → `computeEphemeris`（Alt/Az → ENU → ECEF）
- 渲染：固定相机；`alignLongitudeOnly` 仅绕世界 Y 轴对齐经线；光照方向使用 `-sunWorld`。

