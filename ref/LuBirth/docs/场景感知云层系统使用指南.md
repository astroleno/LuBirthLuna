# 场景感知云层系统使用指南

## 概述

场景感知云层系统是LuBirth项目的新功能，能够根据相机距离自动切换云层渲染策略，在保持性能的同时提供更好的视觉效果。

## 功能特性

### 🎯 场景感知
- **自动检测**：根据相机距离和高度自动判断当前场景类型
- **滞回逻辑**：避免相机微动引起的场景切换抖动
- **平滑过渡**：场景切换时保持视觉连续性

### 🌐 双场景渲染
- **全景场景**（>8km）：3层基础渲染 + 着色器厚度模拟，目标60+ FPS
- **近景场景**（<8km）：12层真实渲染 + POM + 体积散射，目标35+ FPS

### ⚡ 性能优化
- **自适应降级**：根据FPS自动调整渲染质量
- **LOD系统**：动态调整层数和渲染参数
- **性能监控**：实时监控FPS和内存使用

## 使用方法

### 1. 启用场景感知
在UI控制面板中勾选"启用场景感知渲染"复选框。

### 2. 调整场景切换距离
- 默认值：8km
- 范围：5-15km
- 建议：根据实际使用场景调整

### 3. 配置全景场景参数
- **全景层数**：3-6层（默认3）
- **全景厚度**：0.5-2.0倍（默认1.0）
- **厚度模拟层数**：4-12层（默认8）

### 4. 配置近景场景参数
- **近景层数**：8-16层（默认12）
- **POM视差映射**：启用/禁用（默认启用）
- **POM步数**：8-32步（默认16）
- **体积散射**：启用/禁用（默认启用）
- **体积密度**：0.1-0.8（默认0.3）

## 控制台命令

### 测试场景感知系统
```javascript
// 获取当前场景信息
testSceneAwareCloudSystem()
```

### 性能监控
```javascript
// 获取云层性能统计
cloudLayersDebug.getPerformance()

// 性能基准测试
cloudLayersDebug.benchmark()
```

## 技术细节

### 场景检测算法
```typescript
// 滞回逻辑避免抖动
if (currentType === 'panorama' && distance < 8 && height < 5) {
  return 'closeup';
} else if (currentType === 'closeup' && (distance > 10 || height > 7)) {
  return 'panorama';
}
```

### 渲染策略
- **全景策略**：性能优先，使用着色器厚度模拟
- **近景策略**：效果优先，使用真实多层渲染

### 统一光照
- 使用Henyey-Greenstein相位函数
- 统一散射参数（g=0.3）
- 保持远景与近景光照一致性

## 性能指标

### 目标性能
- **全景场景**：60+ FPS（p95 ≤ 16.6ms）
- **近景场景**：35+ FPS（p95 ≤ 28ms）

### 内存使用
- **全景场景**：增长 < 20%
- **近景场景**：增长 < 60%
- **平均增长**：< 40%

## 故障排除

### 常见问题

1. **场景切换不流畅**
   - 检查场景切换距离设置
   - 确认滞回逻辑正常工作

2. **性能下降**
   - 启用自适应降级
   - 调整层数参数
   - 检查性能监控

3. **视觉效果异常**
   - 确认光照参数一致
   - 检查相位函数设置

### 调试命令
```javascript
// 检查当前场景类型
testSceneAwareCloudSystem()

// 性能分析
cloudLayersDebug.benchmark()

// 测试不同层数
cloudLayersDebug.testLayers(8)
```

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现场景感知系统
- ✅ 添加滞回逻辑
- ✅ 基础双场景渲染
- ✅ UI控制面板
- ✅ 性能监控

### 计划功能
- 🔄 全景场景着色器厚度模拟
- 🔄 近景场景真实多层渲染
- 🔄 POM视差映射增强
- 🔄 体积散射效果
- 🔄 性能优化集成

## 技术支持

如有问题，请：
1. 检查控制台错误信息
2. 使用调试命令分析
3. 查看性能监控数据
4. 联系开发团队
