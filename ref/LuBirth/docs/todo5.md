# TODO5 简化地月合照系统

## 项目目标
创建一个简洁的地月合照系统，展示出生当天的地球与月相，移除复杂的PIP系统。

## 系统设计理念

### 核心功能
- **地球展示**：基于用户输入的出生日期和时间
- **月相展示**：基于真实天文计算的精确月相
- **合照效果**：地球和月球在同一画面中和谐展示
- **用户交互**：简单的日期时间选择和视角控制

### 设计原则
- ✅ 简化系统复杂度
- ✅ 提高渲染性能
- ✅ 优化用户体验
- ✅ 确保月相准确性
- ❌ 移除PIP系统
- ❌ 移除潮汐锁定演示
- ❌ 移除复杂的分层渲染

## 当前状态分析

### 已完成工作 ✅
- [x] 地球渲染系统
- [x] 月球基础网格和纹理
- [x] 月球独立光照系统（Uniform着色器）
- [x] 月球基于时间的自转逻辑
- [x] 基础相机控制
- [x] 日期时间选择界面

### 需要简化/移除 ❌
- [ ] PIP（Picture-in-Picture）系统
- [ ] 双相机渲染
- [ ] FBO（Frame Buffer Object）渲染
- [ ] 复杂的分层管理
- [ ] 潮汐锁定演示
- [ ] 相机跟随算法

### 需要优化 🔧
- [ ] 月相计算准确性
- [ ] 月球位置和大小调整
- [ ] 光照一致性
- [ ] 用户界面简化
- [ ] 性能优化

## 详细实施计划

### 阶段1：移除PIP系统

#### 1.1 删除PIP相关文件
**目标**：彻底移除PIP系统及其依赖

**具体任务**：
- [ ] 删除 `/src/scenes/simple/components/PhysicalMoonPIP.tsx`
- [ ] 从 `/src/SimpleTest.tsx` 中移除PIP导入和使用
- [ ] 从 `/src/types/SimpleComposition.ts` 中移除PIP配置
- [ ] 清理相关的UI控制元素

**验收标准**：
- 项目编译无错误
- 不再有FBO相关代码
- 不再有双相机渲染

#### 1.2 简化分层系统
**目标**：移除复杂的分层管理

**具体任务**：
- [ ] 移除相机层级的动态设置
- [ ] 月球始终在layer 0渲染
- [ ] 清理layers相关的代码
- [ ] 简化渲染逻辑

**验收标准**：
- 地球和月球都能正常显示
- 不再有层级相关的调试信息

### 阶段2：优化月球系统

#### 2.1 创建独立月相计算器
**目标**：实现精确的月相计算，不依赖主系统光照

**具体任务**：
- [ ] 创建 `/src/scenes/simple/utils/moonPhaseCalculator.ts`
- [ ] 实现基于天文计算的月相算法
- [ ] 计算太阳、地球、月球的相对位置
- [ ] 返回精确的月相角度和光照方向

**关键算法**：
```typescript
export interface MoonPhaseResult {
  sunDirection: THREE.Vector3;    // 太阳方向向量
  moonRotation: number;           // 月球自转角度
  phaseAngle: number;             // 月相角度
  illumination: number;           // 照明比例 (0-1)
  phaseName: string;              // 月相名称 (新月、上弦月等)
}

export function calculateMoonPhase(
  date: Date,
  observerLat: number,
  observerLon: number
): MoonPhaseResult
```

**验收标准**：
- 月相与真实天文数据一致
- 支持任意日期的计算
- 返回完整的月相信息

#### 2.2 优化月球组件
**目标**：简化月球组件，使用独立的月相计算

**具体任务**：
- [ ] 移除对主系统光照的依赖
- [ ] 使用独立的月相计算器
- [ ] 优化月球自转算法
- [ ] 调整月球大小和位置
- [ ] 简化着色器代码

**验收标准**：
- 月球显示正确的月相
- 自转流畅自然
- 大小与地球协调

#### 2.3 调整地月相对位置
**目标**：优化地球和月球的相对位置，实现更好的合照效果

**具体任务**：
- [ ] 调整月球轨道半径
- [ ] 优化月球在画面中的位置
- [ ] 确保地球和月球的光照方向一致
- [ ] 添加适当的空间深度感

**验收标准**：
- 地月位置自然协调
- 光照方向一致
- 具有良好的视觉效果

### 阶段3：优化用户界面

#### 3.1 简化控制面板
**目标**：移除不必要的控制，专注于核心功能

**具体任务**：
- [ ] 移除PIP相关的控制选项
- [ ] 移除复杂的分层调试选项
- [ ] 简化光照控制
- [ ] 保留日期时间选择
- [ ] 保留基本的视角控制

**验收标准**：
- 界面简洁明了
- 用户易于操作
- 核心功能突出

#### 3.2 优化出生日期输入
**目标**：让用户能方便地输入出生日期和时间

**具体任务**：
- [ ] 优化日期选择器
- [ ] 添加时间选择
- [ ] 显示当前选择的月相信息
- [ ] 添加月相名称显示
- [ ] 考虑添加时区选择

**验收标准**：
- 日期时间输入便捷
- 月相信息准确显示
- 支持全球用户

#### 3.3 添加导出功能
**目标**：允许用户保存地月合照

**具体任务**：
- [ ] 实现截图功能
- [ ] 添加保存按钮
- [ ] 支持不同分辨率导出
- [ ] 考虑添加水印功能

**验收标准**：
- 能正常保存图片
- 图片质量良好
- 操作简单直观

### 阶段4：性能优化和测试

#### 4.1 性能优化
**目标**：提高渲染性能，减少资源占用

**具体任务**：
- [ ] 优化纹理加载
- [ ] 减少不必要的计算
- [ ] 优化着色器性能
- [ ] 添加LOD（细节层次）支持
- [ ] 优化内存使用

**验收标准**：
- 渲染帧率稳定在60fps
- 内存使用合理
- 加载时间快速

#### 4.2 兼容性测试
**目标**：确保在不同设备上正常工作

**具体任务**：
- [ ] 测试不同浏览器
- [ ] 测试移动设备
- [ ] 测试不同屏幕分辨率
- [ ] 验证WebGL兼容性

**验收标准**：
- 在主流浏览器中正常工作
- 移动设备体验良好
- 适配不同屏幕尺寸

#### 4.3 用户体验测试
**目标**：确保系统易于使用

**具体任务**：
- [ ] 测试用户操作流程
- [ ] 验证月相准确性
- [ ] 收集用户反馈
- [ ] 优化交互细节

**验收标准**：
- 用户能轻松完成操作
- 月相计算准确
- 整体体验流畅

## 技术实现细节

### 文件结构规划

```
src/
├── scenes/simple/
│   ├── components/
│   │   ├── Earth.tsx           # 地球组件
│   │   ├── Moon.tsx            # 月球组件（简化版）
│   │   └── CameraControls.tsx  # 相机控制
│   ├── utils/
│   │   ├── moonPhaseCalculator.ts  # 月相计算器
│   │   ├── astronomy.ts         # 天文计算工具
│   │   └── dateUtils.ts        # 日期处理工具
│   └── SimpleEarthMoonScene.tsx # 主场景组件
├── types/
│   └── BirthPhotoComposition.ts # 简化的配置类型
└── App.tsx                     # 主应用
```

### 关键技术点

#### 1. 独立月相计算
- 使用天文算法计算太阳和月球的精确位置
- 考虑岁差、章动等天文现象
- 支持任意历史日期的计算
- 基于儒略日的精确月龄计算
- 真实的月相角度和照明比例计算

#### 2. 独立于Three.js的光照材质实现
**关键技术记录：**
- **自定义ShaderMaterial**：使用`THREE.ShaderMaterial`创建独立的光照系统
- **Uniform照明**：通过`sunDirWorldForShading` uniform传入太阳方向向量
- **朗伯漫反射**：在fragment shader中实现`ndl = max(dot(normal, lightDir), 0.0)`
- **晨昏线过渡**：使用`smoothstep(-0.1, 0.1, ndl)`实现平滑的明暗过渡
- **独立控制**：不依赖主场景光照，实现完全独立的月相显示

**关键着色器代码：**
```glsl
// 计算朗伯漫反射
vec3 normal = normalize(vNormal);
vec3 lightDir = normalize(sunDirWorldForShading);
float ndl = max(dot(normal, lightDir), 0.0);

// 晨昏线过渡（terminator）
float terminator = smoothstep(-0.1, 0.1, ndl);

// 最终颜色 = 基础颜色 * 光照强度 * 漫反射 + 晨昏线过渡
vec3 finalColor = moonColor * lightColor * sunIntensity * (ndl * 0.8 + 0.2) * terminator;
```

#### 4. 简化渲染流程
- 移除FBO和多相机渲染
- 使用标准的Three.js渲染流程
- 优化着色器性能
- 月球始终在layer 0渲染

#### 5. 响应式设计
- 适配不同屏幕尺寸
- 移动设备友好
- 触摸操作支持

### 依赖库要求

#### 核心依赖
- THREE.js r128+
- React 18+
- TypeScript 4.5+

#### 可选依赖
- astronomy-engine（用于精确天文计算）
- date-fns（日期处理）
- html2canvas（截图功能）

## 风险评估与应对

### 技术风险
1. **月相计算精度**：可能需要复杂的天文计算
   - 应对：使用成熟的天文计算库，简化算法
   
2. **性能问题**：复杂场景可能影响性能
   - 应对：优化渲染流程，使用LOD技术

3. **兼容性问题**：不同设备的WebGL支持
   - 应对：添加降级方案，兼容性检测

### 进度风险
1. **开发时间**：功能简化后应该能快速完成
   - 应对：分阶段实现，优先核心功能

2. **测试复杂性**：需要验证月相的准确性
   - 应对：与已知的月相数据进行对比验证

## 成功标准

### 功能标准
- [ ] 用户能输入出生日期时间
- [ ] 正确显示对应的月相
- [ ] 地球和月球在同一画面中
- [ ] 支持基本的视角控制
- [ ] 能保存地月合照

### 性能标准
- [ ] 渲染帧率 ≥ 60fps
- [ ] 内存占用 ≤ 50MB
- [ ] 加载时间 ≤ 2秒

### 质量标准
- [ ] 月相计算准确
- [ ] 视觉效果良好
- [ ] 用户界面友好
- [ ] 代码质量高

## 下一步行动

1. **立即开始**：阶段1 - 移除PIP系统
2. **并行进行**：阶段2 - 优化月球系统
3. **持续验证**：每个阶段完成后进行功能测试

---

*本计划专注于创建一个简洁、准确、用户友好的地月合照系统。*