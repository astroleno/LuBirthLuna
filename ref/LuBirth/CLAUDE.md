# LuBirth 项目设计约束与开发指南

## 顶层设计约束原则
不用测试，每次由用户完成测试。

基于出生点对齐系统重构需求，本项目遵循以下核心设计原则：

### 1. **太阳光固定原则**
太阳光方向保持不变，只有季相变化。这意味着：
- 太阳光照方向由天文算法确定，不受用户交互或地球旋转影响
- 季节性变化仅影响太阳光照强度和色彩，不改变光照方向
- 晨昏线位置由太阳角度和地球自转共同决定，保持天文准确性

### 2. **地球自转原则**
地球沿地轴（Y轴）旋转，符合真实物理规律：
- 地球自转仅绕世界坐标系Y轴（地轴）进行
- 自转角度基于UTC时间计算，确保时区转换正确性
- 自转不受相机视角、用户交互或其他UI状态影响
- 地球姿态的唯一真实来源为场景节点 `earthRoot.quaternion`

### 3. **时区支持原则**
正确处理不同时区的时间转换：
- 用户输入的本地时间需要根据经度计算时区偏移
- UTC时间转换遵循标准：东经为正，UTC时间 = 本地时间 - 时区偏移
- 地球自转角度基于UTC时间计算：`(utcHours * 15 + utcMinutes * 0.25) % 360`
- 时区计算：每15度经度对应1小时时差

### 4. **月球解耦原则**
月球位置和相位独立于地球时间系统：
- 月球位置由独立的天文算法计算，不依赖地球自转状态
- 月相计算基于月球-太阳-地球的几何关系
- 月球屏幕锚定功能不受地球旋转影响
- 月球渲染层与地球系统分离，支持独立的视觉效果

### 5. **纹理映射原则**
贴图seam位于国际日期变更线：
- 地球纹理的经度0°对应贴图中心，180°/-180°对应贴图边缘
- Three.js球面贴图坐标系校正：u=0.5对应经度0°
- 标准球面坐标转换考虑贴图seam的180°偏移
- 确保贴图与地理坐标系的正确对应关系

### 6. **相机控制原则**
支持完整的俯仰角、方位角和视点控制：
- 出生点对齐模式：仅调整相机角度，不修改地球或光照状态
- 相机控制系统统一化，避免多个控制链路的冲突
- 支持手动、自动、出生点对齐三种模式的无缝切换
- 相机状态变更通过统一的状态管理系统，避免直接DOM操作

## 系统架构约束

### 状态管理
- **单一数据源**：避免使用全局变量如 `window.__EARTH_QUAT` 传递状态
- **React单向数据流**：所有状态变更通过组件状态或Context传递
- **异步状态同步**：R3F场景操作与React状态更新的时序协调

### 职责分离
- **出生点对齐**：仅操作相机，不修改地球、太阳、月球状态
- **地球系统**：负责自转、纹理、大气等地球相关功能
- **天文系统**：负责太阳、月球位置计算，与地球系统解耦
- **相机系统**：统一的相机控制入口，支持多种模式

### 坐标系统
- **世界坐标系**：Three.js标准右手坐标系，Y轴向上
- **地理坐标系**：经度[-180°,180°]，纬度[-90°,90°]
- **球面坐标系**：球面贴图UV坐标与地理坐标的正确映射
- **相机坐标系**：球坐标参数化，支持方位角、仰角、距离控制

## 开发规范

### 代码组织
- 按功能模块组织代码：地球、月球、相机、天文算法分离
- 工具函数独立：坐标转换、时间计算等公共函数模块化
- 类型安全：TypeScript接口定义明确，避免any类型滥用

### 调试支持
- **日志系统**：统一的logger工具，支持分级和分类日志
- **诊断工具**：自动化测试命令，验证系统精度和稳定性
- **回退机制**：关键功能提供开关，支持快速回退和问题隔离

### 性能考虑
- **渲染优化**：避免不必要的重渲染和状态更新
- **内存管理**：纹理、几何体等资源的正确释放
- **计算优化**：天文算法和坐标转换的性能优化

## 测试与验证

### 精度要求
- 出生点对齐误差 ≤ 0.5°
- 极值场景（高纬度、大alpha角）误差 ≤ 1.0°
- 多次运行结果一致性，抖动 < 0.1°

### 功能验证
- 固定太阳模式下的光照稳定性
- 季节变化仅影响光照，不影响几何
- PIP模式与主场景的状态隔离
- 时区转换的数值精度

### 边界测试
- 极地地区（南北纬80°以上）的对齐精度
- 日期变更线附近的时区处理
- 大角度相机转动的稳定性
- 长时间运行的状态一致性

---

*此文档随系统重构持续更新，确保设计约束与实现保持一致*